import{i as P,u as I,w as N,v as f,p as D,A as E,B as F,d as z,D as T,C,F as L}from"./main-v4CpkAwU.js";const b="https://openneuro.org/crn/graphql",v="https://s3.us-east-1.amazonaws.com/openneuro.org";async function R(s,a,t){const n=`
    query($datasetId: ID!, $tag: String!, $tree: String) {
      snapshot(datasetId: $datasetId, tag: $tag) {
        files(tree: $tree) {
          id
          key
          filename
          size
          directory
          annexed
        }
      }
    }
  `,r={datasetId:s,tag:a};t&&(r.tree=t);const o=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:n,variables:r})});if(!o.ok)throw new Error(`OpenNeuro API error: ${o.status} ${o.statusText}`);const e=await o.json();if(e.errors?.length)throw new Error(`OpenNeuro GraphQL error: ${JSON.stringify(e.errors)}`);return e.data?.snapshot?.files??[]}async function k(s){const t=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:`
    query($datasetId: ID!) {
      dataset(id: $datasetId) {
        id
        latestSnapshot {
          tag
        }
      }
    }
  `,variables:{datasetId:s}})});if(!t.ok)throw new Error(`OpenNeuro API error: ${t.status} ${t.statusText}`);const n=await t.json();if(n.errors?.length)throw new Error(`OpenNeuro GraphQL error: ${JSON.stringify(n.errors)}`);const r=n.data?.dataset?.latestSnapshot?.tag;if(!r)throw new Error(`No snapshots found for dataset ${s}`);return r}async function S(s,a,t,n=""){const r=await R(s,a,t),o=[];for(const e of r){const c=n?`${n}/${e.filename}`:e.filename;if(e.directory){const h=await S(s,a,e.key,c);o.push(...h)}else o.push({path:c,size:e.size})}return o}function q(s,a,t){const n=`${s}/${a}`;return`${v}/${n}`}async function x(s){const a=await fetch(s,{mode:"cors"});if(!a.ok)throw new Error(`Download failed: ${a.status} ${a.statusText}`);return a}async function A(s,a){const t=[],n=await s.listChildren(!1);for(const r of n){const o=r.getName(),e=a?`${a}/${o}`:o;if(r instanceof T){const c=await A(r,e);t.push(...c)}else r instanceof L&&t.push({path:e,file:r})}return t}const l=P("extensions");function m(s){if(s==null||typeof s!="string")return null;const a=s.trim().toLowerCase();return a.length>0?a:null}I({command:{id:"openneuro_download",name:"Download from OpenNeuro",description:"Download an OpenNeuro dataset to the workspace",parameters:[{name:"datasetId",description:"Dataset ID (e.g. ds000001)",required:!1}]},handler:{execute:async s=>{const a=await N.getWorkspace();if(!a){f("No workspace connected");return}let t=m(s.params?.datasetId);if(!t){const n=await D(l("ENTER_DATASET_ID"),"ds000001");t=m(n)}t&&await E.runAsync(`Download OpenNeuro ${t}`,async n=>{n.message=l("FETCHING_FILE_LIST");const r=await k(t),o=await S(t,r);if(o.length===0){f(`No files found for ${t}`);return}n.totalSteps=o.length,n.currentStep=0;for(let e=0;e<o.length;e++){const{path:c}=o[e];n.message=c,n.currentStep=e;const h=q(t,c),g=`${t}/${c}`;try{const i=await x(h),p=await a.getResource(g,{create:!0}),d=i.body;if(d&&typeof d.pipeTo=="function")await p.saveContents(d);else{const w=await i.blob();await p.saveContents(w)}}catch(i){throw f(`Download failed: ${c} - ${i instanceof Error?i.message:String(i)}`),i}}n.currentStep=o.length,F(`Downloaded ${o.length} files to ${t}`)})}},contribution:{target:"filebrowser.connections",label:"Download from OpenNeuro",icon:"download"}});z.registerContribution("filebrowser.create",{command:"openneuro_download",label:l("CREATE_OPENNEURO_DATASET"),icon:"database"});I({command:{id:"openneuro_validate",name:"Validate OpenNeuro dataset",description:"Validate workspace files against OpenNeuro (size check)",parameters:[{name:"datasetId",description:"Dataset ID",required:!1},{name:"path",description:"Workspace path to dataset folder",required:!1}]},handler:{execute:async s=>{const a=await N.getWorkspace();if(!a){f("No workspace connected");return}let t=m(s.params?.datasetId);if(!t){const e=await D(l("ENTER_DATASET_ID"),"ds000001");t=m(e)}if(!t)return;const r=s.params?.path?.trim()||t;let o;try{const e=await a.getResource(r);if(!e||!(e instanceof T)){f(`Path ${r} is not a directory`);return}o=e}catch{f(`Path ${r} not found`);return}await E.runAsync(`Validate OpenNeuro ${t}`,async e=>{e.message=l("FETCHING_FILE_LIST");const c=await k(t),h=await S(t,c),g=new Map(h.map(u=>[u.path,u.size]));e.message=l("VALIDATING");const i=await A(o,"");e.totalSteps=i.length,e.currentStep=0;let p=0,d=0,w=g.size;for(let u=0;u<i.length;u++){const{path:y,file:_}=i[u];e.message=y,e.currentStep=u;const $=g.get(y);if($===void 0)continue;w--,await _.size()===$?p++:d++}e.currentStep=i.length;const O=d>0||w>0?l("VALIDATE_SUMMARY",{ok:String(p),mismatch:String(d),missing:String(w)}):l("VALIDATE_OK",{ok:String(p)});await C("Validation Complete",O)})}},contribution:{target:"filebrowser.connections",label:"Validate OpenNeuro dataset",icon:"circle-check"}});
