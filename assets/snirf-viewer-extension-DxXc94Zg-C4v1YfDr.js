import{K as Fi,F as Xt,O as pe,b as F,a as Xe,o as q,l as Vi,r as ae,I as qt,t as qe}from"./main-v4CpkAwU.js";function z(t,i,e=0){var r=new Map;for(let[n,s]of t.entries()){let a=g.unpack_from("<"+s,i,e);e+=g.calcsize(s),a.length==1&&(a=a[0]),r.set(n,a)}return r}function B(t){t||t()}function L(t){var i="<"+Array.from(t.values()).join("");return g.calcsize(i)}function me(t,i=8){return Math.ceil(t/i)*i}var ji={u:"Uint",i:"Int",f:"Float"};function Ae(t){var i=g._is_big_endian(t),e,r;if(/S/.test(t))e="getString",r=((t.match(/S(\d*)/)||[])[1]||1)|0;else{let[n,s,a]=t.match(/[<>=!@]?(i|u|f)(\d*)/);r=parseInt(a||4,10);let c=r*8;e="get"+ji[s]+c.toFixed()}return[e,i,r]}var Ui=class{constructor(){this.big_endian=Gi(),this.getters={s:"getUint8",b:"getInt8",B:"getUint8",h:"getInt16",H:"getUint16",i:"getInt32",I:"getUint32",l:"getInt32",L:"getUint32",q:"getInt64",Q:"getUint64",e:"getFloat16",f:"getFloat32",d:"getFloat64"},this.byte_lengths={s:1,b:1,B:1,h:2,H:2,i:4,I:4,l:4,L:4,q:8,Q:8,e:2,f:4,d:8};let t=Object.keys(this.byte_lengths).join("");this.fmt_size_regex="(\\d*)(["+t+"])"}calcsize(t){for(var i=0,e,r=new RegExp(this.fmt_size_regex,"g");(e=r.exec(t))!==null;){let n=parseInt(e[1]||1,10),s=e[2],a=this.byte_lengths[s];i+=n*a}return i}_is_big_endian(t){var i;return/^</.test(t)?i=!1:/^(!|>)/.test(t)?i=!0:i=this.big_endian,i}unpack_from(t,i,r){for(var r=Number(r||0),n=new ge(i,0),s=[],a=this._is_big_endian(t),c,d=new RegExp(this.fmt_size_regex,"g");(c=d.exec(t))!==null;){let l=parseInt(c[1]||1,10),h=c[2],f=this.getters[h],_=this.byte_lengths[h];if(h=="s")s.push(new TextDecoder().decode(i.slice(r,r+l))),r+=l;else for(var o=0;o<l;o++)s.push(n[f](r,!a)),r+=_}return s}},g=new Ui;function Gi(){const t=new Uint8Array(4),i=new Uint32Array(t.buffer);return!((i[0]=1)&t[0])}function Qi(t,i){let e=(i&128)>>7,r=(i&124)>>2,n=((i&3)<<8)+t,s;return r==31?s=n==0?1/0:NaN:r==0?s=2**-14*(n/1024):s=2**(r-15)*(1+n/1024),e?-s:s}var ge=class extends DataView{getFloat16(t,i){let e=[this.getUint8(t),this.getUint8(t+1)];i||e.reverse();let[r,n]=e;return Qi(r,n)}getUint64(t,i){const e=BigInt(this.getUint32(t,i)),r=BigInt(this.getUint32(t+4,i));let n=i?e+(r<<32n):(e<<32n)+r;return Number(n)}getInt64(t,i){var e,r;i?(e=this.getUint32(t,!0),r=this.getInt32(t+4,!0)):(r=this.getInt32(t,!1),e=this.getUint32(t+4,!1));let n=BigInt(e)+(BigInt(r)<<32n);return Number(n)}getString(t,i,e){const r=this.buffer.slice(t,t+e);return new TextDecoder().decode(r)}getVLENStruct(t,i,e){let r=this.getUint32(t,i),n=this.getUint64(t+4,i),s=this.getUint32(t+12,i);return[r,n,s]}};function Wt(t){return t.toString(2).length}function st(t,i,e=0,r=!0){let n=new Uint8Array(i.slice(e,e+t));return r||n.reverse(),n.reduce((a,c,d)=>a+(c<<d*8),0)}var nt=class{constructor(t,i){this.buf=t,this.offset=i,this.dtype=this.determine_dtype()}determine_dtype(){let t=z(Jt,this.buf,this.offset);this.offset+=Zi;let i=t.get("class_and_version")&15;if(i==Ki)return this._determine_dtype_fixed_point(t);if(i==Xi)return this._determine_dtype_floating_point(t);if(i==qi)throw"Time datatype class not supported.";if(i==Wi)return this._determine_dtype_string(t);if(i==Ji)throw"Bitfield datatype class not supported.";if(i==er)throw"Opaque datatype class not supported.";if(i==tr)return this._determine_dtype_compound(t);if(i==ir)return["REFERENCE",t.get("size")];if(i==rr)return this.determine_dtype();if(i==nr)throw"Array datatype class not supported.";if(i==sr){let e=this._determine_dtype_vlen(t);return e[0]=="VLEN_SEQUENCE"&&(e=["VLEN_SEQUENCE",this.determine_dtype()]),e}else throw"Invalid datatype class "+i}_determine_dtype_fixed_point(t){let i=t.get("size");if(![1,2,4,8].includes(i))throw"Unsupported datatype size";let e=t.get("class_bit_field_0")&8;var r;e>0?r="i":r="u";let n=t.get("class_bit_field_0")&1;var s;return n==0?s="<":s=">",this.offset+=4,s+r+i.toFixed()}_determine_dtype_floating_point(t){let i=t.get("size");if(![1,2,4,8].includes(i))throw"Unsupported datatype size";let e="f",r=t.get("class_bit_field_0")&1;var n;return r==0?n="<":n=">",this.offset+=12,n+e+i.toFixed()}_determine_dtype_string(t){return"S"+t.get("size").toFixed()}_determine_dtype_vlen(t){if((t.get("class_bit_field_0")&1)!=1)return["VLEN_SEQUENCE",0,0];let e=t.get("class_bit_field_0")>>4,r=t.get("class_bit_field_1")&1;return["VLEN_STRING",e,r]}_determine_dtype_compound(t){throw"Compound type not yet implemented!"}},Jt=new Map([["class_and_version","B"],["class_bit_field_0","B"],["class_bit_field_1","B"],["class_bit_field_2","B"],["size","I"]]),Zi=L(Jt),Yi=new Map([["offset","I"],["dimensionality","B"],["reserved_0","B"],["reserved_1","B"],["reserved_2","B"],["permutation","I"],["reserved_3","I"],["dim_size_1","I"],["dim_size_2","I"],["dim_size_3","I"],["dim_size_4","I"]]);L(Yi);var Ki=0,Xi=1,qi=2,Wi=3,Ji=4,er=5,tr=6,ir=7,rr=8,sr=9,nr=10;function _e(t){let i=t.length;for(;--i>=0;)t[i]=0}var ar=3,or=258,ei=29,lr=256,cr=lr+1+ei,ti=30,dr=512,_r=new Array((cr+2)*2);_e(_r);var hr=new Array(ti*2);_e(hr);var fr=new Array(dr);_e(fr);var ur=new Array(or-ar+1);_e(ur);var mr=new Array(ei);_e(mr);var pr=new Array(ti);_e(pr);var gr=(t,i,e,r)=>{let n=t&65535|0,s=t>>>16&65535|0,a=0;for(;e!==0;){a=e>2e3?2e3:e,e-=a;do n=n+i[r++]|0,s=s+n|0;while(--a);n%=65521,s%=65521}return n|s<<16|0},Qe=gr,vr=()=>{let t,i=[];for(var e=0;e<256;e++){t=e;for(var r=0;r<8;r++)t=t&1?3988292384^t>>>1:t>>>1;i[e]=t}return i},br=new Uint32Array(vr()),wr=(t,i,e,r)=>{const n=br,s=r+e;t^=-1;for(let a=r;a<s;a++)t=t>>>8^n[(t^i[a])&255];return t^-1},Y=wr,Ze={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ii={Z_NO_FLUSH:0,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFLATED:8},kr=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),yr=function(t){const i=Array.prototype.slice.call(arguments,1);for(;i.length;){const e=i.shift();if(e){if(typeof e!="object")throw new TypeError(e+"must be non-object");for(const r in e)kr(e,r)&&(t[r]=e[r])}}return t},Er=t=>{let i=0;for(let r=0,n=t.length;r<n;r++)i+=t[r].length;const e=new Uint8Array(i);for(let r=0,n=0,s=t.length;r<s;r++){let a=t[r];e.set(a,n),n+=a.length}return e},ri={assign:yr,flattenChunks:Er},si=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{si=!1}var be=new Uint8Array(256);for(let t=0;t<256;t++)be[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;be[254]=be[254]=1;var xr=t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let i,e,r,n,s,a=t.length,c=0;for(n=0;n<a;n++)e=t.charCodeAt(n),(e&64512)===55296&&n+1<a&&(r=t.charCodeAt(n+1),(r&64512)===56320&&(e=65536+(e-55296<<10)+(r-56320),n++)),c+=e<128?1:e<2048?2:e<65536?3:4;for(i=new Uint8Array(c),s=0,n=0;s<c;n++)e=t.charCodeAt(n),(e&64512)===55296&&n+1<a&&(r=t.charCodeAt(n+1),(r&64512)===56320&&(e=65536+(e-55296<<10)+(r-56320),n++)),e<128?i[s++]=e:e<2048?(i[s++]=192|e>>>6,i[s++]=128|e&63):e<65536?(i[s++]=224|e>>>12,i[s++]=128|e>>>6&63,i[s++]=128|e&63):(i[s++]=240|e>>>18,i[s++]=128|e>>>12&63,i[s++]=128|e>>>6&63,i[s++]=128|e&63);return i},Ir=(t,i)=>{if(i<65534&&t.subarray&&si)return String.fromCharCode.apply(null,t.length===i?t:t.subarray(0,i));let e="";for(let r=0;r<i;r++)e+=String.fromCharCode(t[r]);return e},Sr=(t,i)=>{const e=i||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,i));let r,n;const s=new Array(e*2);for(n=0,r=0;r<e;){let a=t[r++];if(a<128){s[n++]=a;continue}let c=be[a];if(c>4){s[n++]=65533,r+=c-1;continue}for(a&=c===2?31:c===3?15:7;c>1&&r<e;)a=a<<6|t[r++]&63,c--;if(c>1){s[n++]=65533;continue}a<65536?s[n++]=a:(a-=65536,s[n++]=55296|a>>10&1023,s[n++]=56320|a&1023)}return Ir(s,n)},Tr=(t,i)=>{i=i||t.length,i>t.length&&(i=t.length);let e=i-1;for(;e>=0&&(t[e]&192)===128;)e--;return e<0||e===0?i:e+be[t[e]]>i?e:i},Ye={string2buf:xr,buf2string:Sr,utf8border:Tr};function Ar(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var Mr=Ar,Ee=16209,zr=16191,Dr=function(i,e){let r,n,s,a,c,d,o,l,h,f,_,u,v,b,w,x,y,m,A,E,p,S,T,k;const I=i.state;r=i.next_in,T=i.input,n=r+(i.avail_in-5),s=i.next_out,k=i.output,a=s-(e-i.avail_out),c=s+(i.avail_out-257),d=I.dmax,o=I.wsize,l=I.whave,h=I.wnext,f=I.window,_=I.hold,u=I.bits,v=I.lencode,b=I.distcode,w=(1<<I.lenbits)-1,x=(1<<I.distbits)-1;e:do{u<15&&(_+=T[r++]<<u,u+=8,_+=T[r++]<<u,u+=8),y=v[_&w];t:for(;;){if(m=y>>>24,_>>>=m,u-=m,m=y>>>16&255,m===0)k[s++]=y&65535;else if(m&16){A=y&65535,m&=15,m&&(u<m&&(_+=T[r++]<<u,u+=8),A+=_&(1<<m)-1,_>>>=m,u-=m),u<15&&(_+=T[r++]<<u,u+=8,_+=T[r++]<<u,u+=8),y=b[_&x];i:for(;;){if(m=y>>>24,_>>>=m,u-=m,m=y>>>16&255,m&16){if(E=y&65535,m&=15,u<m&&(_+=T[r++]<<u,u+=8,u<m&&(_+=T[r++]<<u,u+=8)),E+=_&(1<<m)-1,E>d){i.msg="invalid distance too far back",I.mode=Ee;break e}if(_>>>=m,u-=m,m=s-a,E>m){if(m=E-m,m>l&&I.sane){i.msg="invalid distance too far back",I.mode=Ee;break e}if(p=0,S=f,h===0){if(p+=o-m,m<A){A-=m;do k[s++]=f[p++];while(--m);p=s-E,S=k}}else if(h<m){if(p+=o+h-m,m-=h,m<A){A-=m;do k[s++]=f[p++];while(--m);if(p=0,h<A){m=h,A-=m;do k[s++]=f[p++];while(--m);p=s-E,S=k}}}else if(p+=h-m,m<A){A-=m;do k[s++]=f[p++];while(--m);p=s-E,S=k}for(;A>2;)k[s++]=S[p++],k[s++]=S[p++],k[s++]=S[p++],A-=3;A&&(k[s++]=S[p++],A>1&&(k[s++]=S[p++]))}else{p=s-E;do k[s++]=k[p++],k[s++]=k[p++],k[s++]=k[p++],A-=3;while(A>2);A&&(k[s++]=k[p++],A>1&&(k[s++]=k[p++]))}}else if((m&64)===0){y=b[(y&65535)+(_&(1<<m)-1)];continue i}else{i.msg="invalid distance code",I.mode=Ee;break e}break}}else if((m&64)===0){y=v[(y&65535)+(_&(1<<m)-1)];continue t}else if(m&32){I.mode=zr;break e}else{i.msg="invalid literal/length code",I.mode=Ee;break e}break}}while(r<n&&s<c);A=u>>3,r-=A,u-=A<<3,_&=(1<<u)-1,i.next_in=r,i.next_out=s,i.avail_in=r<n?5+(n-r):5-(r-n),i.avail_out=s<c?257+(c-s):257-(s-c),I.hold=_,I.bits=u},ce=15,at=852,ot=592,lt=0,Ce=1,ct=2,Br=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Rr=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Lr=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Nr=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),Cr=(t,i,e,r,n,s,a,c)=>{const d=c.bits;let o=0,l=0,h=0,f=0,_=0,u=0,v=0,b=0,w=0,x=0,y,m,A,E,p,S=null,T;const k=new Uint16Array(ce+1),I=new Uint16Array(ce+1);let D=null,M,R,O;for(o=0;o<=ce;o++)k[o]=0;for(l=0;l<r;l++)k[i[e+l]]++;for(_=d,f=ce;f>=1&&k[f]===0;f--);if(_>f&&(_=f),f===0)return n[s++]=1<<24|64<<16|0,n[s++]=1<<24|64<<16|0,c.bits=1,0;for(h=1;h<f&&k[h]===0;h++);for(_<h&&(_=h),b=1,o=1;o<=ce;o++)if(b<<=1,b-=k[o],b<0)return-1;if(b>0&&(t===lt||f!==1))return-1;for(I[1]=0,o=1;o<ce;o++)I[o+1]=I[o]+k[o];for(l=0;l<r;l++)i[e+l]!==0&&(a[I[i[e+l]]++]=l);if(t===lt?(S=D=a,T=20):t===Ce?(S=Br,D=Rr,T=257):(S=Lr,D=Nr,T=0),x=0,l=0,o=h,p=s,u=_,v=0,A=-1,w=1<<_,E=w-1,t===Ce&&w>at||t===ct&&w>ot)return 1;for(;;){M=o-v,a[l]+1<T?(R=0,O=a[l]):a[l]>=T?(R=D[a[l]-T],O=S[a[l]-T]):(R=96,O=0),y=1<<o-v,m=1<<u,h=m;do m-=y,n[p+(x>>v)+m]=M<<24|R<<16|O|0;while(m!==0);for(y=1<<o-1;x&y;)y>>=1;if(y!==0?(x&=y-1,x+=y):x=0,l++,--k[o]===0){if(o===f)break;o=i[e+a[l]]}if(o>_&&(x&E)!==A){for(v===0&&(v=_),p+=h,u=o-v,b=1<<u;u+v<f&&(b-=k[u+v],!(b<=0));)u++,b<<=1;if(w+=1<<u,t===Ce&&w>at||t===ct&&w>ot)return 1;A=x&E,n[A]=_<<24|u<<16|p-s|0}}return x!==0&&(n[p+x]=o-v<<24|64<<16|0),c.bits=_,0},ve=Cr,Pr=0,ni=1,ai=2,{Z_FINISH:dt,Z_BLOCK:$r,Z_TREES:xe,Z_OK:ne,Z_STREAM_END:Or,Z_NEED_DICT:Hr,Z_STREAM_ERROR:G,Z_DATA_ERROR:oi,Z_MEM_ERROR:li,Z_BUF_ERROR:Fr,Z_DEFLATED:_t}=ii,ze=16180,ht=16181,ft=16182,ut=16183,mt=16184,pt=16185,gt=16186,vt=16187,bt=16188,wt=16189,Me=16190,K=16191,Pe=16192,kt=16193,$e=16194,yt=16195,Et=16196,xt=16197,It=16198,Ie=16199,Se=16200,St=16201,Tt=16202,At=16203,Mt=16204,zt=16205,Oe=16206,Dt=16207,Bt=16208,N=16209,ci=16210,di=16211,Vr=852,jr=592,Ur=15,Gr=Ur,Rt=t=>(t>>>24&255)+(t>>>8&65280)+((t&65280)<<8)+((t&255)<<24);function Qr(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}var oe=t=>{if(!t)return 1;const i=t.state;return!i||i.strm!==t||i.mode<ze||i.mode>di?1:0},_i=t=>{if(oe(t))return G;const i=t.state;return t.total_in=t.total_out=i.total=0,t.msg="",i.wrap&&(t.adler=i.wrap&1),i.mode=ze,i.last=0,i.havedict=0,i.flags=-1,i.dmax=32768,i.head=null,i.hold=0,i.bits=0,i.lencode=i.lendyn=new Int32Array(Vr),i.distcode=i.distdyn=new Int32Array(jr),i.sane=1,i.back=-1,ne},hi=t=>{if(oe(t))return G;const i=t.state;return i.wsize=0,i.whave=0,i.wnext=0,_i(t)},fi=(t,i)=>{let e;if(oe(t))return G;const r=t.state;return i<0?(e=0,i=-i):(e=(i>>4)+5,i<48&&(i&=15)),i&&(i<8||i>15)?G:(r.window!==null&&r.wbits!==i&&(r.window=null),r.wrap=e,r.wbits=i,hi(t))},ui=(t,i)=>{if(!t)return G;const e=new Qr;t.state=e,e.strm=t,e.window=null,e.mode=ze;const r=fi(t,i);return r!==ne&&(t.state=null),r},Zr=t=>ui(t,Gr),Lt=!0,He,Fe,Yr=t=>{if(Lt){He=new Int32Array(512),Fe=new Int32Array(32);let i=0;for(;i<144;)t.lens[i++]=8;for(;i<256;)t.lens[i++]=9;for(;i<280;)t.lens[i++]=7;for(;i<288;)t.lens[i++]=8;for(ve(ni,t.lens,0,288,He,0,t.work,{bits:9}),i=0;i<32;)t.lens[i++]=5;ve(ai,t.lens,0,32,Fe,0,t.work,{bits:5}),Lt=!1}t.lencode=He,t.lenbits=9,t.distcode=Fe,t.distbits=5},mi=(t,i,e,r)=>{let n;const s=t.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),r>=s.wsize?(s.window.set(i.subarray(e-s.wsize,e),0),s.wnext=0,s.whave=s.wsize):(n=s.wsize-s.wnext,n>r&&(n=r),s.window.set(i.subarray(e-r,e-r+n),s.wnext),r-=n,r?(s.window.set(i.subarray(e-r,e),0),s.wnext=r,s.whave=s.wsize):(s.wnext+=n,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=n))),0},Kr=(t,i)=>{let e,r,n,s,a,c,d,o,l,h,f,_,u,v,b=0,w,x,y,m,A,E,p,S;const T=new Uint8Array(4);let k,I;const D=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(oe(t)||!t.output||!t.input&&t.avail_in!==0)return G;e=t.state,e.mode===K&&(e.mode=Pe),a=t.next_out,n=t.output,d=t.avail_out,s=t.next_in,r=t.input,c=t.avail_in,o=e.hold,l=e.bits,h=c,f=d,S=ne;e:for(;;)switch(e.mode){case ze:if(e.wrap===0){e.mode=Pe;break}for(;l<16;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(e.wrap&2&&o===35615){e.wbits===0&&(e.wbits=15),e.check=0,T[0]=o&255,T[1]=o>>>8&255,e.check=Y(e.check,T,2,0),o=0,l=0,e.mode=ht;break}if(e.head&&(e.head.done=!1),!(e.wrap&1)||(((o&255)<<8)+(o>>8))%31){t.msg="incorrect header check",e.mode=N;break}if((o&15)!==_t){t.msg="unknown compression method",e.mode=N;break}if(o>>>=4,l-=4,p=(o&15)+8,e.wbits===0&&(e.wbits=p),p>15||p>e.wbits){t.msg="invalid window size",e.mode=N;break}e.dmax=1<<e.wbits,e.flags=0,t.adler=e.check=1,e.mode=o&512?wt:K,o=0,l=0;break;case ht:for(;l<16;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(e.flags=o,(e.flags&255)!==_t){t.msg="unknown compression method",e.mode=N;break}if(e.flags&57344){t.msg="unknown header flags set",e.mode=N;break}e.head&&(e.head.text=o>>8&1),e.flags&512&&e.wrap&4&&(T[0]=o&255,T[1]=o>>>8&255,e.check=Y(e.check,T,2,0)),o=0,l=0,e.mode=ft;case ft:for(;l<32;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.head&&(e.head.time=o),e.flags&512&&e.wrap&4&&(T[0]=o&255,T[1]=o>>>8&255,T[2]=o>>>16&255,T[3]=o>>>24&255,e.check=Y(e.check,T,4,0)),o=0,l=0,e.mode=ut;case ut:for(;l<16;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.head&&(e.head.xflags=o&255,e.head.os=o>>8),e.flags&512&&e.wrap&4&&(T[0]=o&255,T[1]=o>>>8&255,e.check=Y(e.check,T,2,0)),o=0,l=0,e.mode=mt;case mt:if(e.flags&1024){for(;l<16;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.length=o,e.head&&(e.head.extra_len=o),e.flags&512&&e.wrap&4&&(T[0]=o&255,T[1]=o>>>8&255,e.check=Y(e.check,T,2,0)),o=0,l=0}else e.head&&(e.head.extra=null);e.mode=pt;case pt:if(e.flags&1024&&(_=e.length,_>c&&(_=c),_&&(e.head&&(p=e.head.extra_len-e.length,e.head.extra||(e.head.extra=new Uint8Array(e.head.extra_len)),e.head.extra.set(r.subarray(s,s+_),p)),e.flags&512&&e.wrap&4&&(e.check=Y(e.check,r,_,s)),c-=_,s+=_,e.length-=_),e.length))break e;e.length=0,e.mode=gt;case gt:if(e.flags&2048){if(c===0)break e;_=0;do p=r[s+_++],e.head&&p&&e.length<65536&&(e.head.name+=String.fromCharCode(p));while(p&&_<c);if(e.flags&512&&e.wrap&4&&(e.check=Y(e.check,r,_,s)),c-=_,s+=_,p)break e}else e.head&&(e.head.name=null);e.length=0,e.mode=vt;case vt:if(e.flags&4096){if(c===0)break e;_=0;do p=r[s+_++],e.head&&p&&e.length<65536&&(e.head.comment+=String.fromCharCode(p));while(p&&_<c);if(e.flags&512&&e.wrap&4&&(e.check=Y(e.check,r,_,s)),c-=_,s+=_,p)break e}else e.head&&(e.head.comment=null);e.mode=bt;case bt:if(e.flags&512){for(;l<16;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(e.wrap&4&&o!==(e.check&65535)){t.msg="header crc mismatch",e.mode=N;break}o=0,l=0}e.head&&(e.head.hcrc=e.flags>>9&1,e.head.done=!0),t.adler=e.check=0,e.mode=K;break;case wt:for(;l<32;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}t.adler=e.check=Rt(o),o=0,l=0,e.mode=Me;case Me:if(e.havedict===0)return t.next_out=a,t.avail_out=d,t.next_in=s,t.avail_in=c,e.hold=o,e.bits=l,Hr;t.adler=e.check=1,e.mode=K;case K:if(i===$r||i===xe)break e;case Pe:if(e.last){o>>>=l&7,l-=l&7,e.mode=Oe;break}for(;l<3;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}switch(e.last=o&1,o>>>=1,l-=1,o&3){case 0:e.mode=kt;break;case 1:if(Yr(e),e.mode=Ie,i===xe){o>>>=2,l-=2;break e}break;case 2:e.mode=Et;break;case 3:t.msg="invalid block type",e.mode=N}o>>>=2,l-=2;break;case kt:for(o>>>=l&7,l-=l&7;l<32;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if((o&65535)!==(o>>>16^65535)){t.msg="invalid stored block lengths",e.mode=N;break}if(e.length=o&65535,o=0,l=0,e.mode=$e,i===xe)break e;case $e:e.mode=yt;case yt:if(_=e.length,_){if(_>c&&(_=c),_>d&&(_=d),_===0)break e;n.set(r.subarray(s,s+_),a),c-=_,s+=_,d-=_,a+=_,e.length-=_;break}e.mode=K;break;case Et:for(;l<14;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(e.nlen=(o&31)+257,o>>>=5,l-=5,e.ndist=(o&31)+1,o>>>=5,l-=5,e.ncode=(o&15)+4,o>>>=4,l-=4,e.nlen>286||e.ndist>30){t.msg="too many length or distance symbols",e.mode=N;break}e.have=0,e.mode=xt;case xt:for(;e.have<e.ncode;){for(;l<3;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.lens[D[e.have++]]=o&7,o>>>=3,l-=3}for(;e.have<19;)e.lens[D[e.have++]]=0;if(e.lencode=e.lendyn,e.lenbits=7,k={bits:e.lenbits},S=ve(Pr,e.lens,0,19,e.lencode,0,e.work,k),e.lenbits=k.bits,S){t.msg="invalid code lengths set",e.mode=N;break}e.have=0,e.mode=It;case It:for(;e.have<e.nlen+e.ndist;){for(;b=e.lencode[o&(1<<e.lenbits)-1],w=b>>>24,x=b>>>16&255,y=b&65535,!(w<=l);){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(y<16)o>>>=w,l-=w,e.lens[e.have++]=y;else{if(y===16){for(I=w+2;l<I;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(o>>>=w,l-=w,e.have===0){t.msg="invalid bit length repeat",e.mode=N;break}p=e.lens[e.have-1],_=3+(o&3),o>>>=2,l-=2}else if(y===17){for(I=w+3;l<I;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}o>>>=w,l-=w,p=0,_=3+(o&7),o>>>=3,l-=3}else{for(I=w+7;l<I;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}o>>>=w,l-=w,p=0,_=11+(o&127),o>>>=7,l-=7}if(e.have+_>e.nlen+e.ndist){t.msg="invalid bit length repeat",e.mode=N;break}for(;_--;)e.lens[e.have++]=p}}if(e.mode===N)break;if(e.lens[256]===0){t.msg="invalid code -- missing end-of-block",e.mode=N;break}if(e.lenbits=9,k={bits:e.lenbits},S=ve(ni,e.lens,0,e.nlen,e.lencode,0,e.work,k),e.lenbits=k.bits,S){t.msg="invalid literal/lengths set",e.mode=N;break}if(e.distbits=6,e.distcode=e.distdyn,k={bits:e.distbits},S=ve(ai,e.lens,e.nlen,e.ndist,e.distcode,0,e.work,k),e.distbits=k.bits,S){t.msg="invalid distances set",e.mode=N;break}if(e.mode=Ie,i===xe)break e;case Ie:e.mode=Se;case Se:if(c>=6&&d>=258){t.next_out=a,t.avail_out=d,t.next_in=s,t.avail_in=c,e.hold=o,e.bits=l,Dr(t,f),a=t.next_out,n=t.output,d=t.avail_out,s=t.next_in,r=t.input,c=t.avail_in,o=e.hold,l=e.bits,e.mode===K&&(e.back=-1);break}for(e.back=0;b=e.lencode[o&(1<<e.lenbits)-1],w=b>>>24,x=b>>>16&255,y=b&65535,!(w<=l);){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(x&&(x&240)===0){for(m=w,A=x,E=y;b=e.lencode[E+((o&(1<<m+A)-1)>>m)],w=b>>>24,x=b>>>16&255,y=b&65535,!(m+w<=l);){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}o>>>=m,l-=m,e.back+=m}if(o>>>=w,l-=w,e.back+=w,e.length=y,x===0){e.mode=zt;break}if(x&32){e.back=-1,e.mode=K;break}if(x&64){t.msg="invalid literal/length code",e.mode=N;break}e.extra=x&15,e.mode=St;case St:if(e.extra){for(I=e.extra;l<I;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.length+=o&(1<<e.extra)-1,o>>>=e.extra,l-=e.extra,e.back+=e.extra}e.was=e.length,e.mode=Tt;case Tt:for(;b=e.distcode[o&(1<<e.distbits)-1],w=b>>>24,x=b>>>16&255,y=b&65535,!(w<=l);){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if((x&240)===0){for(m=w,A=x,E=y;b=e.distcode[E+((o&(1<<m+A)-1)>>m)],w=b>>>24,x=b>>>16&255,y=b&65535,!(m+w<=l);){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}o>>>=m,l-=m,e.back+=m}if(o>>>=w,l-=w,e.back+=w,x&64){t.msg="invalid distance code",e.mode=N;break}e.offset=y,e.extra=x&15,e.mode=At;case At:if(e.extra){for(I=e.extra;l<I;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}e.offset+=o&(1<<e.extra)-1,o>>>=e.extra,l-=e.extra,e.back+=e.extra}if(e.offset>e.dmax){t.msg="invalid distance too far back",e.mode=N;break}e.mode=Mt;case Mt:if(d===0)break e;if(_=f-d,e.offset>_){if(_=e.offset-_,_>e.whave&&e.sane){t.msg="invalid distance too far back",e.mode=N;break}_>e.wnext?(_-=e.wnext,u=e.wsize-_):u=e.wnext-_,_>e.length&&(_=e.length),v=e.window}else v=n,u=a-e.offset,_=e.length;_>d&&(_=d),d-=_,e.length-=_;do n[a++]=v[u++];while(--_);e.length===0&&(e.mode=Se);break;case zt:if(d===0)break e;n[a++]=e.length,d--,e.mode=Se;break;case Oe:if(e.wrap){for(;l<32;){if(c===0)break e;c--,o|=r[s++]<<l,l+=8}if(f-=d,t.total_out+=f,e.total+=f,e.wrap&4&&f&&(t.adler=e.check=e.flags?Y(e.check,n,f,a-f):Qe(e.check,n,f,a-f)),f=d,e.wrap&4&&(e.flags?o:Rt(o))!==e.check){t.msg="incorrect data check",e.mode=N;break}o=0,l=0}e.mode=Dt;case Dt:if(e.wrap&&e.flags){for(;l<32;){if(c===0)break e;c--,o+=r[s++]<<l,l+=8}if(e.wrap&4&&o!==(e.total&4294967295)){t.msg="incorrect length check",e.mode=N;break}o=0,l=0}e.mode=Bt;case Bt:S=Or;break e;case N:S=oi;break e;case ci:return li;case di:default:return G}return t.next_out=a,t.avail_out=d,t.next_in=s,t.avail_in=c,e.hold=o,e.bits=l,(e.wsize||f!==t.avail_out&&e.mode<N&&(e.mode<Oe||i!==dt))&&mi(t,t.output,t.next_out,f-t.avail_out),h-=t.avail_in,f-=t.avail_out,t.total_in+=h,t.total_out+=f,e.total+=f,e.wrap&4&&f&&(t.adler=e.check=e.flags?Y(e.check,n,f,t.next_out-f):Qe(e.check,n,f,t.next_out-f)),t.data_type=e.bits+(e.last?64:0)+(e.mode===K?128:0)+(e.mode===Ie||e.mode===$e?256:0),(h===0&&f===0||i===dt)&&S===ne&&(S=Fr),S},Xr=t=>{if(oe(t))return G;let i=t.state;return i.window&&(i.window=null),t.state=null,ne},qr=(t,i)=>{if(oe(t))return G;const e=t.state;return(e.wrap&2)===0?G:(e.head=i,i.done=!1,ne)},Wr=(t,i)=>{const e=i.length;let r,n,s;return oe(t)||(r=t.state,r.wrap!==0&&r.mode!==Me)?G:r.mode===Me&&(n=1,n=Qe(n,i,e,0),n!==r.check)?oi:(s=mi(t,i,e,e),s?(r.mode=ci,li):(r.havedict=1,ne))},Jr=hi,es=fi,ts=_i,is=Zr,rs=ui,ss=Kr,ns=Xr,as=qr,os=Wr,ls="pako inflate (from Nodeca project)",X={inflateReset:Jr,inflateReset2:es,inflateResetKeep:ts,inflateInit:is,inflateInit2:rs,inflate:ss,inflateEnd:ns,inflateGetHeader:as,inflateSetDictionary:os,inflateInfo:ls};function cs(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var ds=cs,pi=Object.prototype.toString,{Z_NO_FLUSH:_s,Z_FINISH:hs,Z_OK:we,Z_STREAM_END:Ve,Z_NEED_DICT:je,Z_STREAM_ERROR:fs,Z_DATA_ERROR:Nt,Z_MEM_ERROR:us}=ii;function De(t){this.options=ri.assign({chunkSize:1024*64,windowBits:15,to:""},t||{});const i=this.options;i.raw&&i.windowBits>=0&&i.windowBits<16&&(i.windowBits=-i.windowBits,i.windowBits===0&&(i.windowBits=-15)),i.windowBits>=0&&i.windowBits<16&&!(t&&t.windowBits)&&(i.windowBits+=32),i.windowBits>15&&i.windowBits<48&&(i.windowBits&15)===0&&(i.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Mr,this.strm.avail_out=0;let e=X.inflateInit2(this.strm,i.windowBits);if(e!==we)throw new Error(Ze[e]);if(this.header=new ds,X.inflateGetHeader(this.strm,this.header),i.dictionary&&(typeof i.dictionary=="string"?i.dictionary=Ye.string2buf(i.dictionary):pi.call(i.dictionary)==="[object ArrayBuffer]"&&(i.dictionary=new Uint8Array(i.dictionary)),i.raw&&(e=X.inflateSetDictionary(this.strm,i.dictionary),e!==we)))throw new Error(Ze[e])}De.prototype.push=function(t,i){const e=this.strm,r=this.options.chunkSize,n=this.options.dictionary;let s,a,c;if(this.ended)return!1;for(i===~~i?a=i:a=i===!0?hs:_s,pi.call(t)==="[object ArrayBuffer]"?e.input=new Uint8Array(t):e.input=t,e.next_in=0,e.avail_in=e.input.length;;){for(e.avail_out===0&&(e.output=new Uint8Array(r),e.next_out=0,e.avail_out=r),s=X.inflate(e,a),s===je&&n&&(s=X.inflateSetDictionary(e,n),s===we?s=X.inflate(e,a):s===Nt&&(s=je));e.avail_in>0&&s===Ve&&e.state.wrap>0&&t[e.next_in]!==0;)X.inflateReset(e),s=X.inflate(e,a);switch(s){case fs:case Nt:case je:case us:return this.onEnd(s),this.ended=!0,!1}if(c=e.avail_out,e.next_out&&(e.avail_out===0||s===Ve))if(this.options.to==="string"){let d=Ye.utf8border(e.output,e.next_out),o=e.next_out-d,l=Ye.buf2string(e.output,d);e.next_out=o,e.avail_out=r-o,o&&e.output.set(e.output.subarray(d,d+o),0),this.onData(l)}else this.onData(e.output.length===e.next_out?e.output:e.output.subarray(0,e.next_out));if(!(s===we&&c===0)){if(s===Ve)return s=X.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(e.avail_in===0)break}}return!0};De.prototype.onData=function(t){this.chunks.push(t)};De.prototype.onEnd=function(t){t===we&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=ri.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};function ms(t,i){const e=new De(i);if(e.push(t),e.err)throw e.msg||Ze[e.err];return e.result}var ps=ms,gs={inflate:ps},{inflate:vs}=gs,bs=vs,ws=function(t,i){let e=new Uint8Array(t);return bs(e).buffer},ks=function(t,i){let e=t.byteLength,r=new Uint8Array(e),n=Math.floor(e/i),s=new DataView(t);for(var a=0;a<i;a++)for(var c=0;c<n;c++)r[a+c*i]=s.getUint8(a*n+c);return r.buffer},ys=function(t,i){return Es(t),t.slice(0,-4)};function Es(t){for(var i=t.byteLength%2!=0,e=t.byteLength-4,r=new DataView(t),n=0,s=0,a=0;a<e-1;a+=2){let o=r.getUint16(a,!0);n=(n+o)%65535,s=(s+n)%65535}if(i){let o=r.getUint8(e-1);n=(n+o)%65535,s=(s+n)%65535}var[c,d]=g.unpack_from(">HH",t,e);if(c=c%65535,d=d%65535,n!=c||s!=d)throw'ValueError("fletcher32 checksum invalid")';return!0}var xs=1,Is=2,Ss=3,Ct=new Map([[xs,ws],[Is,ks],[Ss,ys]]),gi=class{constructor(t,i){this.fh=t,this.offset=i,this.depth=null}init(){this.all_nodes=new Map,this._read_root_node(),this._read_children()}_read_children(){let t=this.depth;for(;t>0;){for(var i of this.all_nodes.get(t))for(var e of i.get("addresses"))this._add_node(this._read_node(e,t-1));t--}}_read_root_node(){let t=this._read_node(this.offset,null);this._add_node(t),this.depth=t.get("node_level")}_add_node(t){let i=t.get("node_level");this.all_nodes.has(i)?this.all_nodes.get(i).push(t):this.all_nodes.set(i,[t])}_read_node(t,i){return node=this._read_node_header(t,i),node.set("keys",[]),node.set("addresses",[]),node}_read_node_header(t){throw"NotImplementedError: must define _read_node_header in implementation class"}},vi=class extends gi{B_LINK_NODE=new Map([["signature","4s"],["node_type","B"],["node_level","B"],["entries_used","H"],["left_sibling","Q"],["right_sibling","Q"]]);_read_node_header(t,i){let e=z(this.B_LINK_NODE,this.fh,t);if(i!=null&&e.get("node_level")!=i)throw"node level does not match";return e}},Ts=class extends vi{NODE_TYPE=0;constructor(t,i){super(t,i),this.init()}_read_node(t,i){let e=this._read_node_header(t,i);t+=L(this.B_LINK_NODE);let r=[],n=[],s=e.get("entries_used");for(var a=0;a<s;a++){let c=g.unpack_from("<Q",this.fh,t)[0];t+=8;let d=g.unpack_from("<Q",this.fh,t)[0];t+=8,r.push(c),n.push(d)}return r.push(g.unpack_from("<Q",this.fh,t)[0]),e.set("keys",r),e.set("addresses",n),e}symbol_table_addresses(){var t=[],i=this.all_nodes.get(0);for(var e of i)t=t.concat(e.get("addresses"));return t}},As=class extends vi{NODE_TYPE=1;constructor(t,i,e){super(t,i),this.dims=e,this.init()}_read_node(t,i){let e=this._read_node_header(t,i);t+=L(this.B_LINK_NODE);var r=[],n=[];let s=e.get("entries_used");for(var a=0;a<s;a++){let[c,d]=g.unpack_from("<II",this.fh,t);t+=8;let o="<"+this.dims.toFixed()+"Q",l=g.calcsize(o),h=g.unpack_from(o,this.fh,t);t+=l;let f=g.unpack_from("<Q",this.fh,t)[0];t+=8,r.push(new Map([["chunk_size",c],["filter_mask",d],["chunk_offset",h]])),n.push(f)}return e.set("keys",r),e.set("addresses",n),e}construct_data_from_chunks(t,i,e,r){var n,s,a;if(e instanceof Array){let p=e[0];if(p=="REFERENCE"){if(e[1]!=8)throw"NotImplementedError('Unsupported Reference type')";var e="<u8";n="getUint64",s=!1,a=8}else if(p=="VLEN_STRING"||p=="VLEN_SEQUENCE")n="getVLENStruct",s=!1,a=16;else throw"NotImplementedError('datatype not implemented')"}else[n,s,a]=Ae(e);var c=i.reduce(function(p,S){return p*S},1),d=t.reduce(function(p,S){return p*S},1);let o=i.length;var l=1;t.slice().map(function(p){let S=l;return l*=p,S});var l=1,h=i.slice().reverse().map(function(p){let S=l;return l*=p,S}).reverse(),f=new Array(c);let _=d*a;for(var u of this.all_nodes.get(0)){let p=u.get("keys"),S=u.get("addresses"),T=p.length;for(var v=0;v<T;v++){let k=p[v],I=S[v];var b;if(r==null)b=this.fh.slice(I,I+_);else{b=this.fh.slice(I,I+k.get("chunk_size"));let D=k.get("filter_mask");b=this._filter_chunk(b,D,r,a)}for(var w=k.get("chunk_offset").slice(),x=w.slice(),y=x.map(function(){return 0}),m=new ge(b),A=0;A<d;A++){for(var E=o-1;E>=0&&y[E]>=t[E];E--)y[E]=0,x[E]=w[E],E>0&&(y[E-1]+=1,x[E-1]+=1);if(x.slice(0,-1).every(function(M,R){return M<i[R]})){let M=A*a,R=m[n](M,!s,a),O=x.slice(0,-1).reduce(function(V,re,fe){return re*h[fe]+V},0);f[O]=R}y[o-1]+=1,x[o-1]+=1}}}return f}_filter_chunk(t,i,e,r){let n=e.length,s=t.slice();for(var a=n-1;a>=0;a--){if(i&1<<a)continue;let c=e[a],d=c.get("filter_id"),o=c.get("client_data");if(Ct.has(d))s=Ct.get(d)(s,r,o);else throw'NotImplementedError("Filter with id:'+d.toFixed()+' not supported")'}return s}},bi=class extends gi{B_TREE_HEADER=new Map([["signature","4s"],["version","B"],["node_type","B"],["node_size","I"],["record_size","H"],["depth","H"],["split_percent","B"],["merge_percent","B"],["root_address","Q"],["root_nrecords","H"],["total_nrecords","Q"]]);B_LINK_NODE=new Map([["signature","4s"],["version","B"],["node_type","B"]]);constructor(t,i){super(t,i),this.init()}_read_root_node(){let t=this._read_tree_header(this.offset);this.address_formats=this._calculate_address_formats(t),this.header=t,this.depth=t.get("depth");let i=[t.get("root_address"),t.get("root_nrecords"),t.get("total_nrecords")],e=this._read_node(i,this.depth);this._add_node(e)}_read_tree_header(t){return z(this.B_TREE_HEADER,this.fh,this.offset)}_calculate_address_formats(t){let i=t.get("node_size"),e=t.get("record_size"),r=0,n=0,s=new Map,a=t.get("depth");for(var c=0;c<=a;c++){let d="",o="",l="",h,f,_;if(c==0?(h=0,f=0,_=0):c==1?(h=8,d="<Q",f=this._required_bytes(r),o=this._int_format(f),_=0):(h=8,d="<Q",f=this._required_bytes(r),o=this._int_format(f),_=this._required_bytes(n),l=this._int_format(_)),s.set(c,[h,f,_,d,o,l]),c<a){let u=h+f+_;r=this._nrecords_max(i,e,u),n>0?n*=r:n=r}}return s}_nrecords_max(t,i,e){return Math.floor((t-10-e)/(i+e))}_required_bytes(t){return Math.ceil(Wt(t)/8)}_int_format(t){return["<B","<H","<I","<Q"][t-1]}_read_node(t,i){let[e,r,n]=t,s=this._read_node_header(e,i);e+=L(this.B_LINK_NODE);let a=this.header.get("record_size"),c=[];for(let l=0;l<r;l++){let h=this._parse_record(this.fh,e,a);e+=a,c.push(h)}let d=[],o=this.address_formats.get(i);if(i!=0){let[l,h,f,_,u,v]=o;for(let b=0;b<=r;b++){let w=g.unpack_from(_,this.fh,e)[0];e+=l;let x=g.unpack_from(u,this.fh,e)[0];e+=h;let y=x;f>0&&(y=g.unpack_from(v,this.fh,e)[0],e+=f),d.push([w,x,y])}}return s.set("keys",c),s.set("addresses",d),s}_read_node_header(t,i){let e=z(this.B_LINK_NODE,this.fh,t);return e.set("node_level",i),e}*iter_records(){for(let t of this.all_nodes.values())for(let i of t)for(let e of i.get("keys"))yield e}_parse_record(t){throw"NotImplementedError"}},Ms=class extends bi{NODE_TYPE=5;_parse_record(t,i,e){let r=g.unpack_from("<I",t,i)[0];return i+=4,new Map([["namehash",r],["heapid",t.slice(i,i+7)]])}},zs=class extends bi{NODE_TYPE=6;_parse_record(t,i,e){let r=g.unpack_from("<Q",t,i)[0];return i+=8,new Map([["creationorder",r],["heapid",t.slice(i,i+7)]])}},Ds=class{constructor(t,i){let e=g.unpack_from("<B",t,i+8)[0];var r;if(e==0)r=z(ki,t,i),this._end_of_sblock=i+Ns;else if(e==2||e==3)r=z(yi,t,i),this._end_of_sblock=i+Cs;else throw"unsupported superblock version: "+e.toFixed();if(r.get("format_signature")!=Ls)throw"Incorrect file signature: "+r.get("format_signature");if(r.get("offset_size")!=8||r.get("length_size")!=8)throw"File uses non-64-bit addressing";this.version=r.get("superblock_version"),this._contents=r,this._root_symbol_table=null,this._fh=t}get offset_to_dataobjects(){if(this.version==0){var t=new wi(this._fh,this._end_of_sblock,!0);return this._root_symbol_table=t,t.group_offset}else{if(this.version==2||this.version==3)return this._contents.get("root_group_address");throw"Not implemented version = "+this.version.toFixed()}}},Bs=class{constructor(t,i){let e=z(Os,t,i);B(e.get("signature")=="HEAP"),B(e.get("version")==0);let r=e.get("address_of_data_segment"),n=t.slice(r,r+e.get("data_segment_size"));e.set("heap_data",n),this._contents=e,this.data=n}get_object_name(t){let e=new Uint8Array(this.data).indexOf(0,t)-t;return g.unpack_from("<"+e.toFixed()+"s",this.data,t)[0]}},wi=class{constructor(t,i,e=!1){var r;if(e)r=new Map([["symbols",1]]);else{if(r=z(xi,t,i),r.get("signature")!="SNOD")throw"incorrect node type";i+=$s}for(var n=[],s=r.get("symbols"),a=0;a<s;a++)n.push(z(Ei,t,i)),i+=Ps;e&&(this.group_offset=n[0].get("object_header_address")),this.entries=n,this._contents=r}assign_name(t){this.entries.forEach(function(i){let e=i.get("link_name_offset"),r=t.get_object_name(e);i.set("link_name",r)})}get_links(t){var i={};return this.entries.forEach(function(e){let r=e.get("cache_type"),n=e.get("link_name");if(r==0||r==1)i[n]=e.get("object_header_address");else if(r==2){let a=e.get("scratch"),c=new ArrayBuffer(4),d=new Uint8Array(c);for(var s=0;s<4;s++)d[s]=a.charCodeAt(s);let o=g.unpack_from("<I",c,0)[0];i[n]=t.get_object_name(o)}}),i}},Pt=class{constructor(t,i){let e=z(Ii,t,i);i+=$t;let r=e.get("collection_size")-$t,n=t.slice(i,i+r);this.heap_data=n,this._header=e,this._objects=null}get objects(){if(this._objects==null){this._objects=new Map;for(var t=0;t<=this.heap_data.byteLength-Ot;){let i=z(Si,this.heap_data,t);if(i.get("object_index")==0)break;t+=Ot;let e=this.heap_data.slice(t,t+i.get("object_size"));this._objects.set(i.get("object_index"),e),t+=me(i.get("object_size"))}}return this._objects}},Rs=class{constructor(t,i){this.fh=t;let e=z(Ht,t,i);if(i+=L(Ht),B(e.get("signature")=="FRHP"),B(e.get("version")==0),e.get("filter_info_size")>0)throw"Filter info size not supported on FractalHeap";if(e.get("btree_address_huge_objects")==Te)e.set("btree_address_huge_objects",null);else throw"Huge objects not implemented in FractalHeap";e.get("root_block_address")==Te&&e.set("root_block_address",null);let r=e.get("log2_maximum_heap_size"),n=this._min_size_nbits(r),s=new Map([["signature","4s"],["version","B"],["heap_header_adddress","Q"],["block_offset",`${n}B`]]);this.indirect_block_header=new Map(s),this.indirect_block_header_size=L(s),(e.get("flags")&2)==2&&s.set("checksum","I"),this.direct_block_header=s,this.direct_block_header_size=L(s);let a=e.get("maximum_direct_block_size");this._managed_object_offset_size=this._min_size_nbits(r);let c=Math.min(a,e.get("max_managed_object_size"));this._managed_object_length_size=this._min_size_integer(c);let d=e.get("starting_block_size"),o=e.get("table_width");if(!(d>0))throw"Starting block size == 0 not implemented";let l=Number(Math.floor(Math.log2(a)));B(1n<<BigInt(l)==a);let h=Number(Math.floor(Math.log2(d)));B(1n<<BigInt(h)==d),this._max_direct_nrows=l-h+2;let f=Math.floor(Math.log2(o));B(1<<f==o),this._indirect_nrows_sub=f+h-1,this.header=e,this.nobjects=e.get("managed_object_count")+e.get("huge_object_count")+e.get("tiny_object_count");let _=[],u=e.get("root_block_address"),v=0;if(u!=null&&(v=e.get("indirect_current_rows_count")),v>0)for(let y of this._iter_indirect_block(t,u,v))_.push(y);else{let y=this._read_direct_block(t,u,d);_.push(y)}let b=_.reduce((y,m)=>y+m.byteLength,0),w=new Uint8Array(b),x=0;_.forEach(y=>{w.set(new Uint8Array(y),x),x+=y.byteLength}),this.managed=w.buffer}_read_direct_block(t,i,e){let r=t.slice(i,i+e),n=z(this.direct_block_header,r);return B(n.get("signature")=="FHDB"),r}get_data(t){let i=g.unpack_from("<B",t,0)[0],e=i>>4&3,r=i>>6,n=1;if(e==0){B(r==0);let s=this._managed_object_offset_size,a=st(s,t,n);n+=s,s=this._managed_object_length_size;let c=st(s,t,n);return this.managed.slice(a,a+c)}else throw e==1?"tiny objectID not supported in FractalHeap":e==2?"huge objectID not supported in FractalHeap":"unknown objectID type in FractalHeap"}_min_size_integer(t){return this._min_size_nbits(Wt(t))}_min_size_nbits(t){return Math.ceil(t/8)}*_iter_indirect_block(t,i,e){let r=z(this.indirect_block_header,t,i);i+=this.indirect_block_header_size,B(r.get("signature")=="FHIB");let s=r.get("block_offset").reduce((l,h,f)=>l+(h<<f*8),0);r.set("block_offset",s);let[a,c]=this._indirect_info(e),d=[];for(let l=0;l<a;l++){let h=g.unpack_from("<Q",t,i)[0];if(i+=8,h==Te)break;let f=this._calc_block_size(l);d.push([h,f])}let o=[];for(let l=a;l<a+c;l++){let h=g.unpack_from("<Q",t,i)[0];if(i+=8,h==Te)break;let f=this._calc_block_size(l),_=this._iblock_nrows_from_block_size(f);o.push([h,_])}for(let[l,h]of d)yield this._read_direct_block(t,l,h);for(let[l,h]of o)for(let f of this._iter_indirect_block(t,l,h))yield f}_calc_block_size(t){let i=Math.floor(t/this.header.get("table_width"));return 2**Math.max(i-1,0)*this.header.get("starting_block_size")}_iblock_nrows_from_block_size(t){let i=Math.floor(Math.log2(t));return B(2**i==t),i-this._indirect_nrows_sub}_indirect_info(t){let i=this.header.get("table_width"),e=t*i,r=this._max_direct_nrows*i,n,s;return t<=r?(n=e,s=0):(n=r,s=e-r),[n,s]}_int_format(t){return["B","H","I","Q"][t-1]}},Ls=g.unpack_from("8s",new Uint8Array([137,72,68,70,13,10,26,10]).buffer)[0],Te=g.unpack_from("<Q",new Uint8Array([255,255,255,255,255,255,255,255]).buffer)[0],ki=new Map([["format_signature","8s"],["superblock_version","B"],["free_storage_version","B"],["root_group_version","B"],["reserved_0","B"],["shared_header_version","B"],["offset_size","B"],["length_size","B"],["reserved_1","B"],["group_leaf_node_k","H"],["group_internal_node_k","H"],["file_consistency_flags","L"],["base_address_lower","Q"],["free_space_address","Q"],["end_of_file_address","Q"],["driver_information_address","Q"]]),Ns=L(ki),yi=new Map([["format_signature","8s"],["superblock_version","B"],["offset_size","B"],["length_size","B"],["file_consistency_flags","B"],["base_address","Q"],["superblock_extension_address","Q"],["end_of_file_address","Q"],["root_group_address","Q"],["superblock_checksum","I"]]),Cs=L(yi),Ei=new Map([["link_name_offset","Q"],["object_header_address","Q"],["cache_type","I"],["reserved","I"],["scratch","16s"]]),Ps=L(Ei),xi=new Map([["signature","4s"],["version","B"],["reserved_0","B"],["symbols","H"]]),$s=L(xi),Os=new Map([["signature","4s"],["version","B"],["reserved","3s"],["data_segment_size","Q"],["offset_to_free_list","Q"],["address_of_data_segment","Q"]]),Ii=new Map([["signature","4s"],["version","B"],["reserved","3s"],["collection_size","Q"]]),$t=L(Ii),Si=new Map([["object_index","H"],["reference_count","H"],["reserved","I"],["object_size","Q"]]),Ot=L(Si),Ht=new Map([["signature","4s"],["version","B"],["object_index_size","H"],["filter_info_size","H"],["flags","B"],["max_managed_object_size","I"],["next_huge_object_index","Q"],["btree_address_huge_objects","Q"],["managed_freespace_size","Q"],["freespace_manager_address","Q"],["managed_space_size","Q"],["managed_alloc_size","Q"],["next_directblock_iterator_address","Q"],["managed_object_count","Q"],["huge_objects_total_size","Q"],["huge_object_count","Q"],["tiny_objects_total_size","Q"],["tiny_object_count","Q"],["table_width","H"],["starting_block_size","Q"],["maximum_direct_block_size","Q"],["log2_maximum_heap_size","H"],["indirect_starting_rows_count","H"],["root_block_address","Q"],["indirect_current_rows_count","H"]]),Ti=class{constructor(t,i){let e=g.unpack_from("<B",t,i)[0];if(e==1)var[r,n,s]=this._parse_v1_objects(t,i);else if(e==79)var[r,n,s]=this._parse_v2_objects(t,i);else throw"InvalidHDF5File('unknown Data Object Header')";this.fh=t,this.msgs=r,this.msg_data=n,this.offset=i,this._global_heaps={},this._header=s,this._filter_pipeline=null,this._chunk_params_set=!1,this._chunks=null,this._chunk_dims=null,this._chunk_address=null}get dtype(){let i=this.find_msg_type(Xs)[0].get("offset_to_message");return new nt(this.fh,i).dtype}get chunks(){return this._get_chunk_params(),this._chunks}get shape(){let i=this.find_msg_type(Ut)[0].get("offset_to_message");return Hs(this.fh,i)}get filter_pipeline(){if(this._filter_pipeline!=null)return this._filter_pipeline;let t=this.find_msg_type(Js);if(!t.length)return this._filter_pipeline=null,this._filter_pipeline;var i=t[0].get("offset_to_message");let[e,r]=g.unpack_from("<BB",this.fh,i);i+=g.calcsize("<BB");var n=[];if(e==1){let[a,c]=g.unpack_from("<HI",this.fh,i);i+=g.calcsize("<HI");for(var s=0;s<r;s++){let d=z(Pi,this.fh,i);i+=Ys;let o=me(d.get("name_length"),8),l="<"+o.toFixed()+"s",h=g.unpack_from(l,this.fh,i)[0];d.set("filter_name",h),i+=o,l="<"+d.get("client_data_values").toFixed()+"I";let f=g.unpack_from(l,this.fh,i);d.set("client_data",f),i+=4*d.get("client_data_values"),d.get("client_data_values")%2&&(i+=4),n.push(d)}}else if(e==2)for(let a=0;a<r;a++){let c=new Map,d=this.fh,o=g.unpack_from("<H",d,i)[0];i+=2,c.set("filter_id",o);let l=0;o>255&&(l=g.unpack_from("<H",d,i)[0],i+=2);let h=g.unpack_from("<H",d,i)[0];i+=2;let f=(h&1)>0;c.set("optional",f);let _=g.unpack_from("<H",d,i)[0];i+=2;let u;l>0&&(u=g.unpack_from(`${l}s`,d,i)[0],i+=l),c.set("name",u);let v=g.unpack_from(`<${_}i`,d,i);i+=4*_,c.set("client_data",v),c.set("client_data_values",_),n.push(c)}else throw`version ${e} is not supported`;return this._filter_pipeline=n,this._filter_pipeline}find_msg_type(t){return this.msgs.filter(function(i){return i.get("type")==t})}get_attributes(){let t={},i=this.find_msg_type(en);for(let e of i){let r=e.get("offset_to_message"),[n,s]=this.unpack_attribute(r);t[n]=s}return t}get fillvalue(){var i=this.find_msg_type(qs)[0].get("offset_to_message"),e;let r=g.unpack_from("<B",this.fh,i)[0];var n,s,a;if(r==1||r==2)n=z(Ni,this.fh,i),i+=Qs,e=n.get("fillvalue_defined");else if(r==3)n=z(Ci,this.fh,i),i+=Zs,e=n.get("flags")&32;else throw'InvalidHDF5File("Unknown fillvalue msg version: "'+String(r);if(e?(s=g.unpack_from("<I",this.fh,i)[0],i+=4):s=0,s){let[c,d,o]=Ae(this.dtype);a=new ge(this.fh)[c](i,!d,o)}else a=0;return a}unpack_attribute(t){let i=g.unpack_from("<B",this.fh,t)[0];var e,r;if(i==1)e=z(Mi,this.fh,t),B(e.get("version")==1),t+=Fs,r=8;else if(i==3)e=z(zi,this.fh,t),B(e.get("version")==3),t+=Vs,r=1;else throw"unsupported attribute message version: "+i;let n=e.get("name_size"),s=g.unpack_from("<"+n.toFixed()+"s",this.fh,t)[0];s=s.replace(/\x00$/,""),t+=me(n,r);var a;try{a=new nt(this.fh,t).dtype}catch{return console.warn("Attribute "+s+" type not implemented, set to null."),[s,null]}t+=me(e.get("datatype_size"),r);let c=this.determine_data_shape(this.fh,t),d=c.reduce(function(l,h){return l*h},1);t+=me(e.get("dataspace_size"),r);var o=this._attr_value(a,this.fh,d,t);return c.length==0&&(o=o[0]),[s,o]}determine_data_shape(t,i){let e=g.unpack_from("<B",t,i)[0];var r;if(e==1)r=z(We,t,i),B(r.get("version")==1),i+=Di;else if(e==2)r=z(Je,t,i),B(r.get("version")==2),i+=Bi;else throw"unknown dataspace message version";let n=r.get("dimensionality");return g.unpack_from("<"+n.toFixed()+"Q",t,i)}_attr_value(t,i,e,r){var n=new Array(e);if(t instanceof Array){let o=t[0];for(var s=0;s<e;s++)if(o=="VLEN_STRING"){let l=t[2];var[a,c]=this._vlen_size_and_data(i,r);const h=l==0?"ascii":"utf-8",f=new TextDecoder(h);n[s]=f.decode(c),r+=16}else if(o=="REFERENCE"){var d=g.unpack_from("<Q",i,r);n[s]=d,r+=8}else if(o=="VLEN_SEQUENCE"){let l=t[1];var[a,c]=this._vlen_size_and_data(i,r);n[s]=this._attr_value(l,c,a,0),r+=16}else throw"NotImplementedError"}else{let[o,l,h]=Ae(t),f=new ge(i,0);for(var s=0;s<e;s++)n[s]=f[o](r,!l,h),r+=h}return n}_vlen_size_and_data(t,i){let e=g.unpack_from("<I",t,i)[0],r=z(Ai,t,i+4),n=r.get("collection_address");B(r.get("collection_address")<Number.MAX_SAFE_INTEGER);var s;n in this._global_heaps||(s=new Pt(this.fh,n),this._global_heaps[n]=s),s=this._global_heaps[n];let a=s.objects.get(r.get("object_index"));return[e,a]}_parse_v1_objects(t,i){let e=z(Ft,t,i);B(e.get("version")==1);let r=e.get("total_header_messages");for(var n=e.get("object_header_size"),s=i+L(Ft),a=t.slice(s,s+n),c=[[s,n]],d=0,o=0,l=new Array(r),h=0;h<r;h++){o>=n&&([s,n]=c[++d],o=0);let u=z(Ri,t,s+o),v=s+o+jt;if(u.set("offset_to_message",v),u.get("type")==Qt){var[f,_]=g.unpack_from("<QQ",t,v);c.push([f,_])}o+=jt+u.get("size"),l[h]=u}return[l,a,e]}_parse_v2_objects(t,i){var[e,r,n]=this._parse_v2_header(t,i);i=n;for(var s=[],a=e.get("size_of_chunk_0"),c=t.slice(i,i+=a),d=[[n,a]],o=0,l=0;;){if(l>=a-Ge){let v=d[++o];if(v==null)break;[n,a]=v,l=0}let _=z(Li,t,n+l),u=n+l+Ge+r;if(_.set("offset_to_message",u),_.get("type")==Qt){var[h,f]=g.unpack_from("<QQ",t,u);d.push([h+4,f-4])}l+=Ge+_.get("size")+r,s.push(_)}return[s,c,e]}_parse_v2_header(t,i){let e=z(Vt,t,i);var r;if(i+=L(Vt),B(e.get("version")==2),e.get("flags")&4?r=2:r=0,B((e.get("flags")&16)==0),e.get("flags")&32){let s=g.unpack_from("<4I",t,i);i+=16,e.set("access_time",s[0]),e.set("modification_time",s[1]),e.set("change_time",s[2]),e.set("birth_time",s[3])}let n=["<B","<H","<I","<Q"][e.get("flags")&3];return e.set("size_of_chunk_0",g.unpack_from(n,t,i)[0]),i+=g.calcsize(n),[e,r,i]}get_links(){return Object.fromEntries(this.iter_links())}*iter_links(){for(let t of this.msgs)t.get("type")==tn?yield*this._iter_links_from_symbol_tables(t):t.get("type")==Ws?yield this._get_link_from_link_msg(t):t.get("type")==Ks&&(yield*this._iter_link_from_link_info_msg(t))}*_iter_links_from_symbol_tables(t){B(t.get("size")==16);let i=z(js,this.fh,t.get("offset_to_message"));yield*this._iter_links_btree_v1(i.get("btree_address"),i.get("heap_address"))}*_iter_links_btree_v1(t,i){let e=new Ts(this.fh,t),r=new Bs(this.fh,i);for(let n of e.symbol_table_addresses()){let s=new wi(this.fh,n);s.assign_name(r),yield*Object.entries(s.get_links(r))}}_get_link_from_link_msg(t){let i=t.get("offset_to_message");return this._decode_link_msg(this.fh,i)[1]}_decode_link_msg(t,i){let[e,r]=g.unpack_from("<BB",t,i);i+=2,B(e==1);let n=2**(r&3),s=(r&2**3)>0,a=(r&2**4)>0,c=(r&2**2)>0,d;s?(d=g.unpack_from("<B",t,i)[0],i+=1):d=0,B([0,1].includes(d));let o;c&&(o=g.unpack_from("<Q",t,i)[0],i+=8);let l=0;a&&(l=g.unpack_from("<B",t,i)[0],i+=1);let h=l==0?"ascii":"utf-8",f=["<B","<H","<I","<Q"][r&3],_=g.unpack_from(f,t,i)[0];i+=n;let u=new TextDecoder(h).decode(t.slice(i,i+_));i+=_;let v;if(d==0)v=g.unpack_from("<Q",t,i)[0];else if(d==1){let b=g.unpack_from("<H",t,i)[0];i+=2,v=new TextDecoder(h).decode(t.slice(i,i+b))}return[o,[u,v]]}*_iter_link_from_link_info_msg(t){let i=t.get("offset_to_message"),e=this._decode_link_info_msg(this.fh,i),r=e.get("heap_address"),n=e.get("name_btree_address"),s=e.get("order_btree_address");n!=null&&(yield*this._iter_links_btree_v2(n,s,r))}*_iter_links_btree_v2(t,i,e){let r=new Rs(this.fh,e),n;const s=i!=null;s?n=new zs(this.fh,i):n=new Ms(this.fh,t);let a=new Map;for(let d of n.iter_records()){let o=r.get_data(d.get("heapid")),[l,h]=this._decode_link_msg(o,0);const f=s?l:h[0];a.set(f,h)}let c=Array.from(a.keys()).sort();for(let d of c)yield a.get(d)}_decode_link_info_msg(t,i){let[e,r]=g.unpack_from("<BB",t,i);B(e==0),i+=2,(r&1)>0&&(i+=8);let n=(r&2)>0?Gs:Us,s=z(n,t,i),a=new Map;for(let[c,d]of s.entries())a.set(c,d==Ue?null:d);return a}get is_dataset(){return this.find_msg_type(Ut).length>0}get_data(){let i=this.find_msg_type(Gt)[0].get("offset_to_message");var[e,r,n,s]=this._get_data_message_properties(i);if(n==0)throw"Compact storage of DataObject not implemented";if(n==1)return this._get_contiguous_data(s);if(n==2)return this._get_chunked_data(i)}_get_data_message_properties(t){let i,e,r,[n,s,a]=g.unpack_from("<BBB",this.fh,t);return n==1||n==2?(i=s,e=a,r=t,r+=g.calcsize("<BBB"),r+=g.calcsize("<BI"),B(e==1||e==2)):(n==3||n==4)&&(e=s,r=t,r+=g.calcsize("<BB")),B(n>=1&&n<=4),[n,i,e,r]}_get_contiguous_data(t){let[i]=g.unpack_from("<Q",this.fh,t);if(i==Ue){let s=this.shape.reduce(function(a,c){return a*c},1);return new Array(s)}var e=this.shape.reduce(function(s,a){return s*a},1);if(this.dtype instanceof Array){let s=this.dtype[0];if(s=="REFERENCE"){if(this.dtype[1]!=8)throw"NotImplementedError('Unsupported Reference type')";return this.fh.slice(i,i+e)}else if(s=="VLEN_STRING"){const c=this.dtype[2]==0?"ascii":"utf-8",d=new TextDecoder(c);for(var n=[],r=0;r<e;r++){const[l,h]=this._vlen_size_and_data(this.fh,i);n[r]=d.decode(h),i+=16}return n}else throw"NotImplementedError('datatype not implemented')"}else{let s=this.dtype;if(/[<>=!@\|]?(i|u|f|S)(\d*)/.test(s)){let[a,c,d]=Ae(s),o=new Array(e),l=new ge(this.fh);for(var r=0;r<e;r++)o[r]=l[a](i+r*d,!c,d);return o}else throw"not Implemented - no proper dtype defined"}}_get_chunked_data(t){if(this._get_chunk_params(),this._chunk_address==Ue)return[];var i=new As(this.fh,this._chunk_address,this._chunk_dims);let e=i.construct_data_from_chunks(this.chunks,this.shape,this.dtype,this.filter_pipeline);if(this.dtype instanceof Array&&/^VLEN/.test(this.dtype[0])){let s=this.dtype[0];for(var r=0;r<e.length;r++){let[a,c,d]=e[r];var n;c in this._global_heaps?n=this._global_heaps[c]:(n=new Pt(this.fh,c),this._global_heaps[c]=n);let o=n.objects.get(d);if(s=="VLEN_STRING"){const h=this.dtype[2]==0?"ascii":"utf-8",f=new TextDecoder(h);e[r]=f.decode(o)}}}return e}_get_chunk_params(){if(!this._chunk_params_set){this._chunk_params_set=!0;var t=this.find_msg_type(Gt)[0],i=t.get("offset_to_message"),[e,r,n,s]=this._get_data_message_properties(i);if(n==2){var a;if(e==1||e==2){var c=g.unpack_from("<Q",this.fh,s)[0];a=s+g.calcsize("<Q")}else if(e==3){var[r,c]=g.unpack_from("<BQ",this.fh,s);a=s+g.calcsize("<BQ")}B(e>=1&&e<=3);var d="<"+(r-1).toFixed()+"I",o=g.unpack_from(d,this.fh,a);this._chunks=o,this._chunk_dims=r,this._chunk_address=c}}}};function Hs(t,i){let e=g.unpack_from("<B",t,i)[0];var r;if(e==1)r=z(We,t,i),B(r.get("version")==1),i+=Di;else if(e==2)r=z(Je,t,i),B(r.get("version")==2),i+=Bi;else throw"InvalidHDF5File('unknown dataspace message version')";let n=r.get("dimensionality");return g.unpack_from("<"+(n*2).toFixed()+"I",t,i).filter(function(a,c){return c%2==0})}var Ue=g.unpack_from("<Q",new Uint8Array([255,255,255,255,255,255,255,255]).buffer),Ai=new Map([["collection_address","Q"],["object_index","I"]]);L(Ai);var Mi=new Map([["version","B"],["reserved","B"],["name_size","H"],["datatype_size","H"],["dataspace_size","H"]]),Fs=L(Mi),zi=new Map([["version","B"],["flags","B"],["name_size","H"],["datatype_size","H"],["dataspace_size","H"],["character_set_encoding","B"]]),Vs=L(zi),Ft=new Map([["version","B"],["reserved","B"],["total_header_messages","H"],["object_reference_count","I"],["object_header_size","I"],["padding","I"]]),Vt=new Map([["signature","4s"],["version","B"],["flags","B"]]),We=new Map([["version","B"],["dimensionality","B"],["flags","B"],["reserved_0","B"],["reserved_1","I"]]),Di=L(We),Je=new Map([["version","B"],["dimensionality","B"],["flags","B"],["type","B"]]),Bi=L(Je),Ri=new Map([["type","H"],["size","H"],["flags","B"],["reserved","3s"]]),jt=L(Ri),Li=new Map([["type","B"],["size","H"],["flags","B"]]),Ge=L(Li),js=new Map([["btree_address","Q"],["heap_address","Q"]]),Us=new Map([["heap_address","Q"],["name_btree_address","Q"]]),Gs=new Map([["heap_address","Q"],["name_btree_address","Q"],["order_btree_address","Q"]]),Ni=new Map([["version","B"],["space_allocation_time","B"],["fillvalue_write_time","B"],["fillvalue_defined","B"]]),Qs=L(Ni),Ci=new Map([["version","B"],["flags","B"]]),Zs=L(Ci),Pi=new Map([["filter_id","H"],["name_length","H"],["flags","H"],["client_data_values","H"]]),Ys=L(Pi),Ut=1,Ks=2,Xs=3,qs=5,Ws=6,Gt=8,Js=11,en=12,Qt=16,tn=17,rn=class Ke{constructor(i,e,r,n=!1){if(r==null?(this.parent=this,this.file=this):(this.parent=r,this.file=r.file),this.name=i,this._links=e.get_links(),this._dataobjects=e,this._attrs=null,this._keys=null,n)return new Proxy(this,sn)}get keys(){return this._keys==null&&(this._keys=Object.keys(this._links)),this._keys.slice()}get values(){return this.keys.map(i=>this.get(i))}length(){return this.keys.length}_dereference(i){if(!i)throw"cannot deference null reference";let e=this.file._get_object_by_address(i);if(e==null)throw"reference not found in file";return e}get(i){if(typeof i=="number")return this._dereference(i);var e=Zt(i);if(e=="/")return this.file;if(e==".")return this;if(/^\//.test(e))return this.file.get(e.slice(1));if(on(e)!="")var[r,n]=e.split(/\/(.*)/);else var r=e,n=".";if(!(r in this._links))throw r+" not found in group";var s=Zt(this.name+"/"+r);let a=this._links[r];if(typeof a=="string")try{return this.get(a)}catch{return null}var c=new Ti(this.file._fh,a);if(c.is_dataset){if(n!=".")throw s+" is a dataset, not a group";return new an(s,c,this)}else{var d=new Ke(s,c,this);return d.get(n)}}visit(i){return this.visititems((e,r)=>i(e))}visititems(i){var e=this.name.length;/\/$/.test(this.name)||(e+=1);for(var r=this.values.slice();r;){let n=r.shift();r.length==1&&console.log(n);let s=n.name.slice(e),a=i(s,n);if(a!=null)return a;n instanceof Ke&&(r=r.concat(n.values))}return null}get attrs(){return this._attrs==null&&(this._attrs=this._dataobjects.get_attributes()),this._attrs}},sn={get:function(t,i,e){return i in t?t[i]:t.get(i)}},nn=class extends rn{constructor(t,i){var e=new Ds(t,0),r=e.offset_to_dataobjects,n=new Ti(t,r);super("/",n,null),this.parent=this,this._fh=t,this.filename=i||"",this.file=this,this.mode="r",this.userblock_size=0}_get_object_by_address(t){return this._dataobjects.offset==t?this:this.visititems(i=>{i._dataobjects.offset==t})}},an=class extends Array{constructor(t,i,e){super(),this.parent=e,this.file=e.file,this.name=t,this._dataobjects=i,this._attrs=null,this._astype=null}get value(){var t=this._dataobjects.get_data();return this._astype==null?t:t.astype(this._astype)}get shape(){return this._dataobjects.shape}get attrs(){return this._dataobjects.get_attributes()}get dtype(){return this._dataobjects.dtype}get fillvalue(){return this._dataobjects.fillvalue}};function on(t){let i="/",e=t.lastIndexOf(i)+1,r=t.slice(0,e),n=new RegExp("^"+i+"+$"),s=new RegExp(i+"$");return r&&!n.test(r)&&(r=r.replace(s,"")),r}function Zt(t){return t.replace(/\/(\/)+/g,"/")}function te(t){return t==null?[]:Array.isArray(t)?t.flat().map(Number):t instanceof Float64Array||t instanceof Float32Array?Array.from(t):t instanceof Int32Array||t instanceof Uint32Array?Array.from(t).map(Number):typeof t=="number"?[t]:[]}function $i(t,i){const e=te(t);if(e.length===0)return[];if(i&&i.length>=2){const[r,n]=i,s=[];if(r<=4&&n>r){for(let a=0;a<n;a++){const c=[];for(let d=0;d<r;d++)c.push(e[d*n+a]);s.push(c)}return s}for(let a=0;a<r;a++)s.push(e.slice(a*n,(a+1)*n));return s}return[e]}function $(t,i){try{return t.get(i)}catch{return}}function Yt(t){return t==null?[]:Array.isArray(t)?t.flatMap(i=>typeof i=="string"?i:Array.isArray(i)?i.map(String):[]):typeof t=="string"?[t]:[]}function et(t){return t.keys??[]}function ln(t){return et(t).filter(r=>r==="nirs"||/^nirs\d+$/.test(r)).sort((r,n)=>{const s=r==="nirs"?1:parseInt(r.replace(/\D/g,""),10)||0,a=n==="nirs"?1:parseInt(n.replace(/\D/g,""),10)||0;return s-a})}function cn(t){const e=et(t).filter(r=>r==="data"||/^data\d+$/.test(r));return e.length===0?[]:e.sort((r,n)=>{const s=r==="data"?1:parseInt(r.replace(/\D/g,""),10)||0,a=n==="data"?1:parseInt(n.replace(/\D/g,""),10)||0;return s-a})}function dn(t){return et(t).filter(r=>r==="measurementList"||/^measurementList\d+$/.test(r)).sort((r,n)=>{const s=r==="measurementList"?1:parseInt(r.replace(/\D/g,""),10)||0,a=n==="measurementList"?1:parseInt(n.replace(/\D/g,""),10)||0;return s-a})}function ue(t){if(!t?.value)return 0;const i=t.value;return typeof i=="number"?i:Array.isArray(i)&&i.length>0?Number(i[0]):i instanceof Float64Array||i instanceof Float32Array||i instanceof Int32Array||i instanceof Uint32Array?i[0]??0:0}function _n(t,i){const e=$(t,`${i}/sourceIndex`),r=$(t,`${i}/detectorIndex`),n=$(t,`${i}/wavelengthIndex`),s=$(t,`${i}/dataType`),a=$(t,`${i}/dataTypeIndex`);return{sourceIndex:ue(e),detectorIndex:ue(r),wavelengthIndex:ue(n),dataType:ue(s),dataTypeIndex:ue(a)}}function hn(t,i){const e=`${i}/measurementLists`,r=$(t,`${e}/sourceIndex`)?.value,n=$(t,`${e}/detectorIndex`)?.value,s=$(t,`${e}/wavelengthIndex`)?.value,a=$(t,`${e}/dataType`)?.value,c=$(t,`${e}/dataTypeIndex`)?.value,d=te(r),o=te(n),l=te(s),h=te(a),f=te(c),_=Math.max(d.length,o.length,l.length),u=[];for(let v=0;v<_;v++)u.push({sourceIndex:d[v]??0,detectorIndex:o[v]??0,wavelengthIndex:l[v]??0,dataType:h[v]??0,dataTypeIndex:f[v]??0});return u}function fn(t,i){const e=$(t,`${i}/dataTimeSeries`),r=$(t,`${i}/time`);if(!e?.value)return null;const n=$i(e.value,e.shape);let s=te(r?.value);if(s.length===2&&n.length>0){const[d,o]=s,l=n.length;s=Array.from({length:l},(h,f)=>d+f*o)}let a=[];if($(t,`${i}/measurementLists`))a=hn(t,i);else try{const d=t.get(i);a=dn(d).map(l=>_n(t,`${i}/${l}`))}catch{a=[]}return{dataTimeSeries:n,time:s,measurementList:a}}function un(t,i){const e=[`${i}/probe`,`${i}/probe0`,`${i}/probe1`,`${i}/Probe`];let r;for(const d of e){const o=$(t,d);if(o!=null){r=d;break}}if(!r)try{const l=(t.get(i).keys??[]).find(h=>/^probe\d*$/i.test(h));l&&(r=`${i}/${l}`)}catch{}if(!r)return;const n=d=>{const o=$(t,`${r}/${d}`);if(o?.value===void 0)return;const l=$i(o.value,o.shape);return l.length>0?l:void 0},s=d=>{const o=$(t,`${r}/${d}`);return o?.value!==void 0?te(o.value):void 0},a=d=>{const o=$(t,`${r}/${d}`);if(o?.value===void 0)return;const l=Yt(o.value);return l.length>0?l:void 0},c=d=>{const o=$(t,`${r}/${d}`);if(o?.value===void 0)return;const l=Yt(o.value);if(l.length===0)return;const h=o.shape;if(h&&h.length>=2){const[f,_]=h,u=[];for(let v=0;v<f;v++)u.push(l.slice(v*_,(v+1)*_));return u.length>0?u:void 0}return[l]};return{wavelengths:s("wavelengths"),wavelengthsEmission:s("wavelengthsEmission"),sourcePos2D:n("sourcePos2D"),sourcePos3D:n("sourcePos3D"),detectorPos2D:n("detectorPos2D"),detectorPos3D:n("detectorPos3D"),sourceLabels:c("sourceLabels"),detectorLabels:a("detectorLabels")}}async function mn(t){try{const i=new nn(t,"snirf"),e={nirs:[]},r=$(i,"formatVersion");r?.value&&(e.formatVersion=typeof r.value=="string"?r.value:String(r.value));const n=ln(i);for(const s of n){const a=i.get(s),c=cn(a),d=[];for(const l of c){const h=`${s}/${l}`,f=fn(i,h);f&&d.push(f)}const o=un(i,s);e.nirs.push({data:d,probe:o})}return e}catch(i){throw new Error(`Failed to parse SNIRF file: ${i instanceof Error?i.message:String(i)}`)}}function ee(t,i){return getComputedStyle(document.documentElement).getPropertyValue(t).trim()||i}function pn(t,i,e,r){const n=(i+e)/2,s=Math.max(e-i,1e-10),a=(t-n)/s;if(a<=-.8)return r("--wa-color-blue-50","rgb(59,130,246)");if(a>=.8)return r("--wa-color-red-50","rgb(239,68,68)");const c=a<=0?0:a>=1?255:Math.round(255*a),d=a>=0?0:a<=-1?255:Math.round(255*-a),o=a>=0?Math.round(255*(1-a)):Math.round(255*(1+a));return`rgb(${c},${o},${d})`}function gn(t){return t>100?50:t>20?20:t>5?5:1}function Kt(t){if(!t?.dataTimeSeries?.length)return{vMin:0,vMax:1};let i=1/0,e=-1/0;for(const r of t.dataTimeSeries)for(const n of r)typeof n=="number"&&isFinite(n)&&(i=Math.min(i,n),e=Math.max(e,n));return i===1/0?{vMin:0,vMax:1}:{vMin:i,vMax:e}}function vn(t,i,e){const r=String(t).padStart(3,"0"),n=i?.measurementList?.[t];if(!n)return`${r}: ${t}`;const s=e?.sourceLabels?.[n.sourceIndex-1],a=e?.detectorLabels?.[n.detectorIndex-1],c=Array.isArray(s)?s[0]:s,d=Array.isArray(a)?a[0]:a,o=typeof c=="string"&&typeof d=="string"?`${c}_${d}`:`S${n.sourceIndex}_D${n.detectorIndex}`,l=e?.wavelengths?.[n.wavelengthIndex-1],h=typeof l=="number"?`${o} ${Math.round(l)}`:o;return`${r}: ${h}`}var bn=Object.defineProperty,wn=Object.getOwnPropertyDescriptor,he=(t,i,e,r)=>{for(var n=r>1?void 0:r?wn(i,e):i,s=t.length-1,a;s>=0;s--)(a=t[s])&&(n=(r?a(i,e,n):a(n))||n);return r&&n&&bn(i,e,n),n};let ie=class extends qt{constructor(){super(...arguments),this.block=null,this.timeIndex=0,this.timeViewStart=null,this.timeViewEnd=null,this.rowHeight=28,this.lastChartLayout=null,this.chartScheduled=!1,this.chartContainerObserved=!1,this.handleChartWheel=t=>{const i=this.getTimeViewState();if(!i)return;const{fullSpan:e,viewStart:r,viewEnd:n,viewSpan:s}=i,a=(r+n)/2,c=t.deltaY>0?1.2:1/1.2,d=Math.min(Math.max(s*c,e/1e3),e);this.clampAndSetTimeView(a,d),t.preventDefault()},this.handleTimeScrollbarPointerDown=t=>{const i=t.target.closest(".time-scrollbar-track");if(!i)return;const e=this.getTimeViewState();if(!e)return;const{tMin:r,fullSpan:n,viewSpan:s}=e,a=i.getBoundingClientRect(),c=r+(t.clientX-a.left)/a.width*n;this.dispatchTimeIndexChange(this.timeToIndex(c)),this.clampAndSetTimeView(c,s),t.target.setPointerCapture(t.pointerId)},this.handleTimeScrollbarThumbPointerDown=t=>{t.stopPropagation();const i=t.target,e=i.closest(".time-scrollbar-track"),r=this.getTimeViewState();if(!e||!r)return;const{fullSpan:n,viewStart:s,viewSpan:a}=r,c=t.clientX;i.setPointerCapture(t.pointerId);const d=l=>{const h=e.getBoundingClientRect(),f=(l.clientX-c)/h.width*n,_=s+f+a/2;this.clampAndSetTimeView(_,a)},o=()=>{i.releasePointerCapture(t.pointerId),i.removeEventListener("pointermove",d),i.removeEventListener("pointerup",o),i.removeEventListener("pointercancel",o)};i.addEventListener("pointermove",d),i.addEventListener("pointerup",o),i.addEventListener("pointercancel",o)},this.handleChartPointerDown=t=>{const i=t.target.closest("#chartWrapper"),e=i?.querySelector(".time-series-canvas");if(!i||!e||!this.lastChartLayout||!this.block?.time?.length)return;const r=e.getBoundingClientRect(),n=t.clientX-r.left,{pad:s,plotW:a,vStart:c,tRange:d}=this.lastChartLayout,o=Math.min(...this.block.time),l=Math.max(...this.block.time),h=b=>{const w=b-r.left;return c+(w-s.l)/a*d},f=this.block.time[this.timeIndex],_=s.l+(f-c)/d*a;if(Math.abs(n-_)<=12){t.preventDefault(),i.setPointerCapture(t.pointerId);const b=x=>{const y=Math.max(o,Math.min(l,h(x.clientX)));this.dispatchTimeIndexChange(this.timeToIndex(y))},w=()=>{i.releasePointerCapture(t.pointerId),i.removeEventListener("pointermove",b),i.removeEventListener("pointerup",w),i.removeEventListener("pointercancel",w)};i.addEventListener("pointermove",b),i.addEventListener("pointerup",w),i.addEventListener("pointercancel",w)}else{const b=Math.max(o,Math.min(l,h(t.clientX)));this.dispatchTimeIndexChange(this.timeToIndex(b))}}}getTimeBounds(){if(!this.block?.time?.length)return null;const t=Math.min(...this.block.time),i=Math.max(...this.block.time);return{tMin:t,tMax:i}}getTimeViewState(){const t=this.getTimeBounds();if(!t)return null;const{tMin:i,tMax:e}=t,r=e-i,n=this.timeViewStart??i,s=this.timeViewEnd??e,a=s-n;return{tMin:i,tMax:e,fullSpan:r,viewStart:n,viewEnd:s,viewSpan:a}}timeToIndex(t){if(!this.block?.time?.length)return 0;let i=0,e=1/0;for(let r=0;r<this.block.time.length;r++){const n=Math.abs(this.block.time[r]-t);n<e&&(e=n,i=r)}return i}setTimeView(t,i){const e=this.getTimeBounds();if(!e)return;const{tMin:r,tMax:n}=e,s=i-t,a=n-r,c=Math.max(a/1e3,.01),d=Math.min(Math.max(s,c),a),o=Math.max(r,Math.min(n-d,t)),l=o+d;this.dispatchEvent(new CustomEvent("time-view-change",{detail:{start:o,end:l},bubbles:!0}))}clampAndSetTimeView(t,i){const e=this.getTimeViewState();if(!e)return;const{tMin:r,tMax:n}=e,s=i/2;let a=t-s,c=t+s;a<r?(a=r,c=r+i):c>n&&(c=n,a=n-i),this.setTimeView(a,c)}dispatchTimeIndexChange(t){this.dispatchEvent(new CustomEvent("time-index-change",{detail:t,bubbles:!0}))}drawTimeSeries(t,i){if(!this.block||!t)return;const e=t.getContext("2d");if(!e)return;const{dataTimeSeries:r,time:n}=this.block,s=r[0]?.length??0;if(s===0)return;const a={t:28,r:12,b:24,l:36},c=r.length;if(c<2)return;const d=Math.min(...n),o=Math.max(...n),l=o-d||1,h=this.timeViewStart??d,f=this.timeViewEnd??o,_=Math.max(f-h,l*.01),u=Math.max(d,Math.min(o-_,h)),v=Math.min(o,u+_),b=v-u||1,w=this.rowHeight-4,x=4,y=a.t+a.b+s*(w+x);t.height=y;const m=i-a.l-a.r,A=s*(w+x)-x;e.fillStyle=ee("--wa-color-surface-default","#1a1a1a"),e.fillRect(0,0,i,y);const E=ee("--wa-color-text-normal","#1a1a1a");let p=1/0,S=-1/0;for(let C=0;C<s;C++)for(let J=0;J<c;J++){const Z=r[J][C];typeof Z=="number"&&isFinite(Z)&&(p=Math.min(p,Z),S=Math.max(S,Z))}const k=Math.max(S-p,1e-10)*.1,I=k>=1||k<=.001?k.toExponential(1):k.toFixed(3),D=n[this.timeIndex]??u;let M,R=!0;u<=D&&D<=v?M=a.l+(D-u)/b*m:D<u?(M=a.l,R=!1):(M=a.l+m,R=!1);for(let C=0;C<s;C++){const J=a.t+C*(w+x),Z=w-2,Oi=C<s-1&&this.block.measurementList&&this.block.measurementList[C]&&this.block.measurementList[C+1]&&(this.block.measurementList[C].sourceIndex!==this.block.measurementList[C+1].sourceIndex||this.block.measurementList[C].detectorIndex!==this.block.measurementList[C+1].detectorIndex);let ke=1/0,ye=-1/0;for(let P=0;P<c;P++){const U=r[P][C];typeof U=="number"&&isFinite(U)&&(ke=Math.min(ke,U),ye=Math.max(ye,U))}const tt=ye-ke||1,it=ke-tt*.05,Hi=ye+tt*.05-it;e.strokeStyle=ee("--wa-color-neutral-border-quiet","rgba(128,128,128,0.25)"),e.lineWidth=1,e.strokeRect(a.l,J,m,Z),Oi&&(e.strokeStyle=ee("--wa-color-neutral-border-normal","rgba(128,128,128,0.5)"),e.lineWidth=1.5,e.beginPath(),e.moveTo(a.l,J+Z+1),e.lineTo(a.l+m,J+Z+1),e.stroke()),e.strokeStyle=E,e.lineWidth=1.5,e.beginPath();let rt=!0;const Le=(P,U)=>{const se=a.l+(P-u)/b*m,le=J+Z-(Number(U)-it)/Hi*Z;rt?(e.moveTo(se,le),rt=!1):e.lineTo(se,le)};for(let P=0;P<c;P++){const U=n[P];if(U<u){if(P+1<c&&n[P+1]>=u){const se=n[P+1],le=(u-U)/(se-U),Ne=Number(r[P][C])+le*(Number(r[P+1][C])-Number(r[P][C]));Le(u,Ne)}continue}if(U>v){if(P>0&&n[P-1]<=v){const se=n[P-1],le=(v-se)/(U-se),Ne=Number(r[P-1][C])+le*(Number(r[P][C])-Number(r[P-1][C]));Le(v,Ne)}break}Le(U,r[P][C])}e.stroke()}const O=ee("--wa-color-cyan-50","#00bcd4");e.strokeStyle=R?O:"rgba(0,188,212,0.5)",e.lineWidth=R?2:1,e.setLineDash(R?[]:[4,4]),e.beginPath(),e.moveTo(M,a.t),e.lineTo(M,a.t+A),e.stroke(),e.setLineDash([]);const V=a.t+A,re=`${D.toFixed(2)} s`;e.font="11px system-ui, sans-serif",e.textAlign="center",e.textBaseline="top";const fe=Math.max(a.l+30,Math.min(a.l+m-30,M));e.fillStyle=O,e.fillText(re,fe,V+6);const j=24,Re=a.t+4;e.strokeStyle=ee("--wa-color-text-quiet","rgba(150,150,150,0.8)"),e.fillStyle=ee("--wa-color-text-quiet","rgba(150,150,150,0.8)"),e.lineWidth=2,e.beginPath(),e.moveTo(a.l+4,Re),e.lineTo(a.l+4,Re+j),e.stroke(),e.font="10px system-ui, sans-serif",e.textAlign="left",e.textBaseline="top",e.fillText(I,a.l+10,Re),this.lastChartLayout={pad:a,plotW:m,vStart:u,tRange:b,time:n}}renderTimeScrollbar(){const i=this.block?.time;if(!i?.length||i.length<2)return pe;const e=this.getTimeViewState();if(!e)return pe;const{tMin:r,tMax:n,fullSpan:s,viewStart:a,viewSpan:c}=e,d=s||1,o=(a-r)/d*100,l=c/d*100,h=i[this.timeIndex]??a+c/2,f=(h-r)/d*100,_=gn(d),u=Math.floor(r/_)*_,v=[];for(let b=u;b<=n;b+=_)b>=r&&v.push(b);return F`
      <div class="time-axis-footer">
        <div class="time-axis-label">Time (s)</div>
        <div class="time-axis-ticks">
          ${v.map(b=>F`
              <span class="time-axis-tick" style="left: ${(b-r)/d*100}%">
                ${b}
              </span>
            `)}
        </div>
        <div class="time-scrollbar" @pointerdown=${this.handleTimeScrollbarPointerDown}>
          <div class="time-scrollbar-track">
            <div
              class="time-scrollbar-thumb"
              style="left: ${o}%; width: ${l}%"
              @pointerdown=${this.handleTimeScrollbarThumbPointerDown}
            ></div>
            <div
              class="time-scrollbar-cursor"
              style="left: ${f}%"
              title="${h.toFixed(2)} s"
            ></div>
          </div>
        </div>
      </div>
    `}scheduleChartDraw(){this.chartScheduled||(this.chartScheduled=!0,requestAnimationFrame(()=>{this.chartScheduled=!1;const t=this.renderRoot?.querySelector("#chartWrapper"),i=this.renderRoot?.querySelector(".time-series-canvas");if(i&&t){const e=t.getBoundingClientRect();i.width=e.width,this.drawTimeSeries(i,e.width)}}))}connectedCallback(){super.connectedCallback(),this.resizeObserver=new ResizeObserver(()=>this.scheduleChartDraw())}disconnectedCallback(){this.resizeObserver?.disconnect(),super.disconnectedCallback()}updated(t){if(super.updated?.(t),t.has("block")&&!this.block&&(this.chartContainerObserved=!1),(t.has("block")||t.has("timeIndex")||t.has("timeViewStart")||t.has("timeViewEnd"))&&this.scheduleChartDraw(),this.chartContainerObserved||!this.resizeObserver||!this.block)return;const i=this.renderRoot?.querySelector("#chartContainer");i&&(this.resizeObserver.observe(i),this.chartContainerObserved=!0)}render(){if(!this.block)return pe;const t=this.block.dataTimeSeries[0]?.length??0;return F`
      <div class="chart-container" id="chartContainer">
        <div class="chart-scroll-area">
          <div class="chart-body">
            <div class="chart-labels">
              ${Array.from({length:t},(i,e)=>F`
                    <div
                      class="chart-label"
                      style="height: ${this.rowHeight}px; line-height: ${this.rowHeight}px;"
                    >
                      ${vn(e,this.block,this.probe)}
                    </div>
                  `)}
            </div>
            <div
              class="chart-wrapper"
              id="chartWrapper"
              @wheel=${this.handleChartWheel}
              @pointerdown=${this.handleChartPointerDown}
            >
              <canvas class="time-series-canvas"></canvas>
            </div>
          </div>
        </div>
        <div class="chart-time-footer">${this.renderTimeScrollbar()}</div>
      </div>
    `}};ie.styles=Xe`
    :host {
      display: flex;
      flex: 1;
      min-width: 0;
      min-height: 0;
    }

    .chart-container {
      flex: 1;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chart-scroll-area {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: auto;
    }

    .chart-body {
      display: flex;
      min-width: min-content;
    }

    .chart-labels {
      flex-shrink: 0;
      min-width: 100px;
      padding-top: 28px;
      padding-right: 0;
      background: var(--wa-color-surface-default);
    }

    .chart-label {
      font-size: 11px;
      color: var(--wa-color-text-normal);
      text-align: right;
      white-space: nowrap;
    }

    .chart-wrapper {
      flex: 1;
      min-width: 0;
      cursor: pointer;
    }

    .chart-time-footer {
      flex-shrink: 0;
      padding-top: 4px;
      background: var(--wa-color-surface-default);
      border-top: 1px solid var(--wa-color-neutral-border-quiet);
    }

    .time-series-canvas {
      width: 100%;
      display: block;
      border-radius: 4px;
    }

    .time-axis-footer {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .time-axis-label {
      font-size: 11px;
      color: var(--wa-color-text-quiet);
      text-align: center;
    }

    .time-axis-ticks {
      position: relative;
      height: 14px;
      font-size: 10px;
      color: var(--wa-color-text-quiet);
    }

    .time-axis-tick {
      position: absolute;
      transform: translateX(-50%);
      white-space: nowrap;
    }

    .time-scrollbar {
      flex-shrink: 0;
      padding: 2px 0;
    }

    .time-scrollbar-track {
      height: 12px;
      background: var(--wa-color-surface-raised);
      border: 1px solid var(--wa-color-neutral-border-quiet);
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .time-scrollbar-thumb {
      position: absolute;
      top: 0;
      bottom: 0;
      min-width: 20px;
      background: var(--wa-color-cyan-50);
      border-radius: 4px;
      cursor: grab;
      opacity: 0.7;
    }

    .time-scrollbar-thumb:hover {
      opacity: 1;
    }

    .time-scrollbar-thumb:active {
      cursor: grabbing;
    }

    .time-scrollbar-cursor {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3px;
      margin-left: -1.5px;
      background: var(--wa-color-cyan-50, #00bcd4);
      pointer-events: none;
      z-index: 1;
    }
  `;he([q({attribute:!1})],ie.prototype,"block",2);he([q({attribute:!1})],ie.prototype,"probe",2);he([q({type:Number})],ie.prototype,"timeIndex",2);he([q({attribute:!1})],ie.prototype,"timeViewStart",2);he([q({attribute:!1})],ie.prototype,"timeViewEnd",2);ie=he([qe("snirf-time-series")],ie);var kn=Object.defineProperty,yn=Object.getOwnPropertyDescriptor,Be=(t,i,e,r)=>{for(var n=r>1?void 0:r?yn(i,e):i,s=t.length-1,a;s>=0;s--)(a=t[s])&&(n=(r?a(i,e,n):a(n))||n);return r&&n&&kn(i,e,n),n};const H=350;let de=class extends qt{constructor(){super(...arguments),this.block=null,this.timeIndex=0,this.resolve=(t,i)=>ee(t,i),this.valueToColor=(t,i,e)=>pn(t,i,e,this.resolve)}getChannelCountAndRowAtTime(){const t=this.block;if(!t?.dataTimeSeries?.length)return null;const i=t.dataTimeSeries,e=i.length,r=i[0]?.length??0,n=t.measurementList?.length??0;if(e===0&&r===0&&n===0)return null;const s=e>=r||r===0&&n>0,a=Math.max(s?r:e,n);if(a===0)return null;const c=s?e:r,d=Math.min(Math.max(0,this.timeIndex),c-1),o=s?(i[d]??[]).slice(0,a):i.map(l=>Number(l[d]??0)).slice(0,a);return{nChannels:a,rowAtTime:o}}drawCanvas(t){if(!t||!this.block)return;const i=t.getContext("2d");if(!i)return;const e=this.resolve("--wa-color-surface-raised","#1e1e1e"),r=this.resolve("--wa-color-neutral-border-quiet","rgba(128,128,128,0.5)"),n=this.resolve("--wa-color-cyan-50","#00bcd4"),s=this.resolve("--wa-color-green-50","#4caf50");if(t.width=H,t.height=H,i.fillStyle=e,i.fillRect(0,0,H,H),!((this.probe?.sourcePos2D?.length??0)>0||(this.probe?.sourcePos3D?.length??0)>0||(this.probe?.detectorPos2D?.length??0)>0||(this.probe?.detectorPos3D?.length??0)>0)){this.drawChannelGrid(i,r);return}this.drawProbeGeometry(i,n,s,r)}drawChannelGrid(t,i){const e=this.getChannelCountAndRowAtTime();if(!e)return;const{nChannels:r,rowAtTime:n}=e,{vMin:s,vMax:a}=Kt(this.block),c=Math.ceil(Math.sqrt(r)),d=Math.ceil(r/c),o=H/c,l=H/d,h=Math.min(o,l)*.35;t.strokeStyle=i,t.lineWidth=2,t.beginPath(),t.ellipse(H/2,H/2,140,170,0,0,2*Math.PI),t.stroke();const f=u=>typeof u=="number"&&isFinite(u),_=this.resolve("--wa-color-neutral-50","rgba(180,180,180,0.8)");for(let u=0;u<r;u++){const v=u%c,b=Math.floor(u/c),w=o*(v+.5),x=l*(b+.5),y=n[u],m=f(y)&&s!==1/0&&a!==-1/0?this.valueToColor(y,s,a):_;t.fillStyle=m,t.beginPath(),t.arc(w,x,h,0,2*Math.PI),t.fill()}}drawProbeGeometry(t,i,e,r){const n=this.block,s=this.probe;if(!n||!s)return;let a=s?.sourcePos2D??s?.sourcePos3D,c=s?.detectorPos2D??s?.detectorPos3D,d=!1;const o=new Map,l=new Map;if(!a?.length&&!c?.length&&n?.measurementList?.length){d=!0;const E=[...new Set(n.measurementList.map(M=>M.sourceIndex))].sort((M,R)=>M-R),p=[...new Set(n.measurementList.map(M=>M.detectorIndex))].sort((M,R)=>M-R),S=Math.max(E.length,1),T=Math.max(p.length,1),k=80,I=H/2,D=H/2;a=E.map((M,R)=>{const O=R/S*2*Math.PI-Math.PI/2,V=[I+k*Math.cos(O),D+k*Math.sin(O)];return o.set(M,V),V}),c=p.map((M,R)=>{const O=R/T*2*Math.PI-Math.PI/2+Math.PI/4,V=[I+k*.7*Math.cos(O),D+k*.7*Math.sin(O)];return l.set(M,V),V})}if(!a?.length||!c?.length){this.drawChannelGrid(t,r);return}const h=a,f=c,_=H/2,u=(E,p)=>{if(d)return{x:E,y:p};const S=[...h.map(j=>j[0]),...f.map(j=>j[0])].filter(j=>typeof j=="number"),T=[...h.map(j=>j[1]),...f.map(j=>j[1])].filter(j=>typeof j=="number");if(S.length===0||T.length===0)return{x:_,y:_};const k=Math.min(...S),I=Math.max(...S),D=Math.min(...T),M=Math.max(...T),V=150/(Math.max(I-k,M-D,1e-10)*1.2),re=(k+I)/2,fe=(D+M)/2;return{x:_+(E-re)*V,y:_-(p-fe)*V}},v=this.getChannelCountAndRowAtTime();if(!v)return;const{rowAtTime:b}=v,{vMin:w,vMax:x}=Kt(n),y=Math.max(x-w,1e-10),A=(n?.measurementList??[]).slice(0,80).map((E,p)=>{const S=(d?o.get(E.sourceIndex):h[E.sourceIndex-1])??h[0],T=(d?l.get(E.detectorIndex):f[E.detectorIndex-1])??f[0],k=u(S[0],S[1]),I=u(T[0],T[1]),D=b[p],M=typeof D=="number"&&isFinite(D)?this.valueToColor(D,w,x):r,R=typeof D=="number"&&isFinite(D)?(D-w)/y:.5,O=1+R*3,V=(k.x+I.x)/2,re=(k.y+I.y)/2;return{x1:k.x,y1:k.y,x2:I.x,y2:I.y,stroke:M,lineWidth:O,midX:V,midY:re,norm:R}});t.fillStyle=i;for(const E of h){const p=u(E[0]??0,E[1]??0);t.beginPath(),t.arc(p.x,p.y,6,0,2*Math.PI),t.fill()}t.fillStyle=e;for(const E of f){const p=u(E[0]??0,E[1]??0);t.fillRect(p.x-5,p.y-5,10,10)}t.lineCap="round";for(const E of A)t.strokeStyle=E.stroke,t.lineWidth=E.lineWidth,t.beginPath(),t.moveTo(E.x1,E.y1),t.lineTo(E.x2,E.y2),t.stroke();for(const E of A){const p=3+E.norm*5;t.fillStyle=E.stroke,t.beginPath(),t.arc(E.midX,E.midY,p,0,2*Math.PI),t.fill(),t.strokeStyle="rgba(255,255,255,0.5)",t.lineWidth=1,t.stroke()}}renderProbeLegend(){return F`
      <div class="probe-legend">
        <span>low</span>
        <div
          class="probe-legend-bar"
          style="background: linear-gradient(to right, var(--wa-color-blue-50), var(--wa-color-neutral-50), var(--wa-color-red-50));"
        ></div>
        <span>high</span>
      </div>
    `}updated(t){super.updated?.(t);const i=this.shadowRoot?.querySelector(".probe-canvas")??null;this.drawCanvas(i)}render(){if(!this.block)return pe;const t=(this.probe?.sourcePos2D?.length??0)>0||(this.probe?.sourcePos3D?.length??0)>0||(this.probe?.detectorPos2D?.length??0)>0||(this.probe?.detectorPos3D?.length??0)>0,i=this.getChannelCountAndRowAtTime()!==null;return!t&&!i?F`<div class="probe-placeholder">No probe geometry</div>`:F`
      <div class="probe-canvas-container">
        <canvas class="probe-canvas" width=${H} height=${H}></canvas>
      </div>
      ${this.renderProbeLegend()}
    `}};de.styles=Xe`
    :host {
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .probe-canvas-container {
      width: ${H}px;
      height: ${H}px;
      flex-shrink: 0;
    }

    .probe-canvas {
      display: block;
      width: ${H}px;
      height: ${H}px;
      border-radius: 4px;
    }

    .probe-legend {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--wa-color-text-quiet);
    }

    .probe-legend-bar {
      flex: 1;
      height: 8px;
      border-radius: 4px;
    }

    .probe-placeholder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--wa-color-text-quiet);
      font-size: 0.875rem;
    }
  `;Be([q({attribute:!1})],de.prototype,"block",2);Be([q({attribute:!1})],de.prototype,"probe",2);Be([q({type:Number})],de.prototype,"timeIndex",2);de=Be([qe("snirf-probe-layout")],de);var En=Object.defineProperty,xn=Object.getOwnPropertyDescriptor,W=(t,i,e,r)=>{for(var n=r>1?void 0:r?xn(i,e):i,s=t.length-1,a;s>=0;s--)(a=t[s])&&(n=(r?a(i,e,n):a(n))||n);return r&&n&&En(i,e,n),n};const In=t=>t.getName().toLowerCase().endsWith(".snirf");Vi.registerEditorInputHandler({canHandle:t=>t instanceof Xt&&In(t),handle:async t=>{const i={title:t.getName(),data:t,key:t.getWorkspacePath(),editorId:"snirf-viewer",icon:"waveform",noOverflow:!1,state:{}};return i.widgetFactory=()=>F`<k-snirf-viewer id="snirf-viewer" .input=${i}></k-snirf-viewer>`,i},ranking:1e3});let Q=class extends Fi{constructor(){super(...arguments),this.loading=!0,this.selectedBlock=0,this.timeViewStart=null,this.timeViewEnd=null,this.timeIndex=0,this.isEditor=!0,this.zoomIn=()=>{const t=this.currentBlock;if(!t?.time?.length)return;const i=Math.min(...t.time),e=Math.max(...t.time),r=this.timeViewStart??i,n=this.timeViewEnd??e,s=(r+n)/2,a=(n-r)/1.5,c=a/2;let d=s-c,o=s+c;d<i?(d=i,o=i+a):o>e&&(o=e,d=e-a),this.timeViewStart=d,this.timeViewEnd=o},this.zoomOut=()=>{const t=this.currentBlock;if(!t?.time?.length)return;const i=Math.min(...t.time),e=Math.max(...t.time),r=e-i,n=this.timeViewStart??i,s=this.timeViewEnd??e,a=(n+s)/2,c=Math.min((s-n)*1.5,r),d=c/2;let o=a-d,l=a+d;o<i?(o=i,l=i+c):l>e&&(l=e,o=e-c),this.timeViewStart=o,this.timeViewEnd=l},this.zoomReset=()=>{this.timeViewStart=null,this.timeViewEnd=null}}doClose(){this.input=void 0,this.data=void 0,this.error=void 0}async doInitUI(){await this.loadFile()}async loadFile(){if(!this.input?.data||!(this.input.data instanceof Xt)){this.error="No file to display",this.loading=!1;return}const t=this.input.data;try{const e=await(await t.getContents({blob:!0})).arrayBuffer();this.data=await mn(e),this.data?.nirs[0]?.data?.length&&(this.timeIndex=0)}catch(i){this.error=i instanceof Error?i.message:"Failed to load SNIRF file"}finally{this.loading=!1}}get currentBlock(){if(!this.data?.nirs[0])return null;const t=this.data.nirs[0].data;return t[this.selectedBlock]??t[0]??null}renderToolbar(){if(!this.data||this.loading||this.error)return pe;const i=this.currentBlock?.dataTimeSeries?.length??0;return F`
      <div class="toolbar">
        ${this.data.nirs[0].data.length>1?F`
              <select
                @change=${e=>{this.selectedBlock=parseInt(e.target.value,10)}}
              >
                ${this.data.nirs[0].data.map((e,r)=>F`<option value=${r} ?selected=${r===this.selectedBlock}>
                      Data ${r+1}
                    </option>`)}
              </select>
            `:null}
        ${i>1?F`
              <div class="toolbar-zoom">
                <wa-button
                  type="button"
                  size="small"
                  appearance="outlined"
                  variant="neutral"
                  title="Zoom in"
                  @click=${this.zoomIn}
                >
                  <wa-icon name="magnifying-glass-plus" label="Zoom in"></wa-icon>
                </wa-button>
                <wa-button
                  type="button"
                  size="small"
                  appearance="outlined"
                  variant="neutral"
                  title="Zoom out"
                  @click=${this.zoomOut}
                >
                  <wa-icon name="magnifying-glass-minus" label="Zoom out"></wa-icon>
                </wa-button>
                <wa-button
                  type="button"
                  size="small"
                  appearance="outlined"
                  variant="neutral"
                  title="Reset zoom"
                  @click=${this.zoomReset}
                >
                  <wa-icon name="maximize" label="Reset zoom"></wa-icon>
                </wa-button>
              </div>
            `:null}
      </div>
   `}render(){if(this.error)return F`
        <div class="error-state">
          <wa-icon name="triangle-exclamation"></wa-icon>
          <span>${this.error}</span>
        </div>
      `;if(this.loading)return F`
        <div class="loading-state">
          <wa-spinner></wa-spinner>
          <span>Loading SNIRF file...</span>
        </div>
      `;const t=this.currentBlock;return!this.data||!t?F`
        <div class="error-state">
          <span>No data in SNIRF file</span>
        </div>
      `:F`
      <div class="viewer-layout">
        <div class="viewer-panels">
          <div class="panel chart-panel">
            <h3 class="panel-title">Time series</h3>
            <snirf-time-series
              .block=${t}
              .probe=${this.data.nirs[0]?.probe}
              .timeIndex=${this.timeIndex}
              .timeViewStart=${this.timeViewStart}
              .timeViewEnd=${this.timeViewEnd}
              @time-index-change=${i=>{this.timeIndex=i.detail}}
              @time-view-change=${i=>{this.timeViewStart=i.detail.start,this.timeViewEnd=i.detail.end}}
            ></snirf-time-series>
          </div>
          <div class="panel probe-panel">
            <h3 class="panel-title">Probe layout</h3>
            <snirf-probe-layout
              .block=${t}
              .probe=${this.data.nirs[0]?.probe}
              .timeIndex=${this.timeIndex}
            ></snirf-probe-layout>
          </div>
        </div>
      </div>
    `}updated(t){super.updated?.(t),t.has("data")&&this.data&&(this.timeViewStart=null,this.timeViewEnd=null),t.has("selectedBlock")&&this.currentBlock&&(this.timeIndex=0,this.timeViewStart=null,this.timeViewEnd=null)}};Q.styles=Xe`
    :host {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      background: var(--wa-color-surface-default);
    }

    .viewer-layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      min-height: 0;
      overflow: hidden;
    }

    .viewer-panels {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: 1fr;
      gap: 1rem;
      min-height: 200px;
      overflow: auto;
    }

    .panel {
      background: var(--wa-color-surface-raised);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .panel-title {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--wa-color-text-normal);
    }

    .chart-panel {
      min-width: 0;
    }

    .chart-panel snirf-time-series {
      flex: 1;
    }

    .probe-panel {
      width: 350px;
      min-width: 350px;
      flex-shrink: 0;
      overflow: auto;
      display: flex;
      flex-direction: column;
    }

    .probe-panel snirf-probe-layout {
      flex: 1 1 auto;
      min-height: 350px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .toolbar-zoom {
      display: flex;
      gap: 0.25rem;
    }

    .error-state,
    .loading-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--wa-space-s);
      color: var(--wa-color-text-quiet);
    }
  `;W([q({attribute:!1})],Q.prototype,"input",2);W([ae()],Q.prototype,"error",2);W([ae()],Q.prototype,"loading",2);W([ae()],Q.prototype,"data",2);W([ae()],Q.prototype,"selectedBlock",2);W([ae()],Q.prototype,"timeViewStart",2);W([ae()],Q.prototype,"timeViewEnd",2);W([ae()],Q.prototype,"timeIndex",2);Q=W([qe("k-snirf-viewer")],Q);export{Q as KSnirfViewer};
