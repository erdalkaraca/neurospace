const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/transformers-CGE3r2Rj.js","assets/main-v4CpkAwU.js","assets/main-DCTlflHk.css"])))=>i.map(i=>d[i]);
import{M as L,_ as ue,s as de,h as he,j as _,d as R,J as y,G as fe,q as ge,c as S,N as F}from"./main-v4CpkAwU.js";var H=(c=>(c.ZERO_SHOT_CLASSIFICATION="Xenova/distilbert-base-uncased-mnli",c.FEATURE_EXTRACTION="Xenova/all-MiniLM-L6-v2",c.TEXT_CLASSIFICATION="Xenova/distilbert-base-uncased-finetuned-sst-2-english",c.QUESTION_ANSWERING="Xenova/distilbert-base-cased-distilled-squad",c.SUMMARIZATION="Xenova/distilbart-cnn-6-6",c.TRANSLATION_EN_FR="Xenova/opus-mt-en-fr",c.FILL_MASK="Xenova/distilbert-base-uncased",c.SENTENCE_SIMILARITY="Xenova/all-MiniLM-L6-v2",c.TOKEN_CLASSIFICATION="Xenova/distilbert-base-uncased-finetuned-conll03-english",c.IMAGE_CLASSIFICATION="Xenova/vit-base-patch16-224",c.OBJECT_DETECTION="Xenova/detr-resnet-50",c.AUTOMATIC_SPEECH_RECOGNITION="Xenova/whisper-tiny",c.AUDIO_CLASSIFICATION="Xenova/wav2vec2-base",c))(H||{}),W=(c=>(c.ZERO_SHOT_CLASSIFICATION="zero-shot-classification",c.FEATURE_EXTRACTION="feature-extraction",c.TEXT_CLASSIFICATION="text-classification",c.SENTIMENT_ANALYSIS="sentiment-analysis",c.QUESTION_ANSWERING="question-answering",c.SUMMARIZATION="summarization",c.TRANSLATION="translation",c.FILL_MASK="fill-mask",c.SENTENCE_SIMILARITY="sentence-similarity",c.TOKEN_CLASSIFICATION="token-classification",c.IMAGE_CLASSIFICATION="image-classification",c.OBJECT_DETECTION="object-detection",c.AUTOMATIC_SPEECH_RECOGNITION="automatic-speech-recognition",c.AUDIO_CLASSIFICATION="audio-classification",c.IMAGE_TO_TEXT="image-to-text",c.TEXT_TO_IMAGE="text-to-image",c.IMAGE_SEGMENTATION="image-segmentation",c.DEPTH_ESTIMATION="depth-estimation",c))(W||{});function me(c){switch(c){case"zero-shot-classification":return"Xenova/distilbert-base-uncased-mnli";case"feature-extraction":return"Xenova/all-MiniLM-L6-v2";case"text-classification":case"sentiment-analysis":return"Xenova/distilbert-base-uncased-finetuned-sst-2-english";case"question-answering":return"Xenova/distilbert-base-cased-distilled-squad";case"summarization":return"Xenova/distilbart-cnn-6-6";case"translation":return"Xenova/opus-mt-en-fr";case"fill-mask":return"Xenova/distilbert-base-uncased";case"sentence-similarity":return"Xenova/all-MiniLM-L6-v2";case"token-classification":return"Xenova/distilbert-base-uncased-finetuned-conll03-english";case"image-classification":return"Xenova/vit-base-patch16-224";case"object-detection":return"Xenova/detr-resnet-50";case"automatic-speech-recognition":return"Xenova/whisper-tiny";case"audio-classification":return"Xenova/wav2vec2-base";default:return null}}let O=null,D=!1;async function X(){O||(O=ue(()=>import("./transformers-CGE3r2Rj.js"),__vite__mapDeps([0,1,2])));const c=await O;return D||(c.env.allowRemoteModels=!0,c.env.allowLocalModels=!1,c.env.remoteHost="https://huggingface.co",D=!0),c}async function pe(c){const{env:e}=await X();c&&c.trim()?e.useAuthToken=c.trim():e.useAuthToken=null}const E=L("InBrowserMLService");class w{constructor(){this.pipelines=new Map,this.loadingPipelines=new Set}static getInstance(){return w.instance||(w.instance=new w),w.instance}setAuthToken(e){pe(e).then(()=>{e&&e.trim()&&E.info("Hugging Face token set for authenticated model access")}).catch(t=>{E.warn(`Failed to configure auth token: ${t instanceof Error?t.message:String(t)}`)})}async getPipeline(e,t,n={}){if(!t&&typeof e!="string"){const r=me(e);r&&(t=r)}const s=e,o=t,a=`${s}:${o}`;if(this.pipelines.has(a))return this.pipelines.get(a);if(this.loadingPipelines.has(a)){for(;this.loadingPipelines.has(a);)await new Promise(r=>setTimeout(r,100));return this.pipelines.get(a)}this.loadingPipelines.add(a);try{E.info(`Loading transformers.js pipeline: ${s} with model ${o}...`);const{pipeline:r}=await X(),i=await r(s,o,{quantized:!0,...n});return this.pipelines.set(a,i),E.info(`Pipeline ${a} loaded successfully`),i}catch(r){const i=r instanceof Error?r.message:String(r);throw E.error(`Failed to load pipeline ${a}: ${i}`),r}finally{this.loadingPipelines.delete(a)}}clearPipeline(e,t){const o=`${e}:${t}`;this.pipelines.delete(o)}clearAllPipelines(){this.pipelines.clear()}}const Ce=w.getInstance(),j="events/aiservice/streamStarted",G="events/aiservice/streamChunk",K="events/aiservice/streamComplete",I="events/aiservice/streamError",J="events/aiservice/aiConfigChanged",B="events/aiservice/agentWorkflowStarted",V="events/aiservice/agentWorkflowComplete",Z="events/aiservice/agentWorkflowError",Y="aiservice.agents",Q="aiservice.chatProviders",ee="aiservice.promptEnhancers",T="aiConfig",te={defaultProvider:"openai",providers:[]},b=10,ye=5,ze=Object.freeze(Object.defineProperty({__proto__:null,AI_CONFIG_TEMPLATE:te,CID_AGENTS:Y,CID_CHAT_PROVIDERS:Q,CID_PROMPT_ENHANCERS:ee,KEY_AI_CONFIG:T,MAX_RECENT_TOOL_CALLS:ye,MAX_TOOL_ITERATIONS:b,TOPIC_AGENT_WORKFLOW_COMPLETE:V,TOPIC_AGENT_WORKFLOW_ERROR:Z,TOPIC_AGENT_WORKFLOW_STARTED:B,TOPIC_AICONFIG_CHANGED:J,TOPIC_AI_STREAM_CHUNK:G,TOPIC_AI_STREAM_COMPLETE:K,TOPIC_AI_STREAM_ERROR:I,TOPIC_AI_STREAM_STARTED:j},Symbol.toStringTag,{value:"Module"}));class ne{constructor(){this.decoder=new TextDecoder}*processLines(e){for(const t of e)t.trim()!==""&&(yield t)}}class Ae extends ne{constructor(){super(...arguments),this.usage=null}async*parse(e){let t="";this.usage=null;try{for(;;){const{done:s,value:o}=await e.read();if(s)break;t+=this.decoder.decode(o,{stream:!0});const a=t.split(`
`);t=a.pop()||"";for(const r of this.processLines(a))if(r.startsWith("data: ")){const i=r.slice(6).trim();if(i==="[DONE]"){const l={type:"done",content:""};this.usage&&(l.metadata={usage:this.usage}),yield l;continue}try{const l=JSON.parse(i);if(l.error){yield{type:"error",content:l.error.message||"Unknown error",metadata:l.error};continue}this.extractUsage(l);const h=this.parseChunk(l);h&&(yield h)}catch{continue}}}if(t.trim()&&t.startsWith("data: ")){const s=t.slice(6).trim();if(s!=="[DONE]")try{const o=JSON.parse(s);this.extractUsage(o);const a=this.parseChunk(o);a&&(yield a)}catch{}}const n={type:"done",content:""};this.usage&&(n.metadata={usage:this.usage}),yield n}finally{e.releaseLock()}}extractUsage(e){if(e.usage){const t=e.usage;this.usage={promptTokens:t.prompt_tokens||0,completionTokens:t.completion_tokens||0,totalTokens:t.total_tokens||0,estimated:!1}}}parseChunk(e){const t=e.choices?.[0]?.delta,n=e.choices?.[0];if(t?.content)return{type:"token",content:t.content,message:{role:t.role||"assistant",content:n?.message?.content||t.content}};if(n?.message?.tool_calls){const s=this.parseToolCalls(n.message.tool_calls,!0);if(s.length>0)return{type:"token",content:"",toolCalls:s}}else if(t?.tool_calls||n?.delta?.tool_calls){const s=this.parseToolCalls(t?.tool_calls||n?.delta?.tool_calls||[],!1);if(s.length>0)return{type:"token",content:"",toolCalls:s}}return null}parseToolCalls(e,t=!1){return e.filter(n=>n.function!==void 0).map((n,s)=>({id:n.id||`call_${n.index!==void 0?n.index:s}_${Date.now()}`,type:"function",function:{name:n.function?.name||"",arguments:n.function?.arguments||(t?"{}":"")},_index:n.index!==void 0?n.index:s}))}}class Te extends ne{constructor(){super(...arguments),this.usage=null}async*parse(e){let t="";this.usage=null;try{for(;;){const{done:s,value:o}=await e.read();if(s)break;t+=this.decoder.decode(o,{stream:!0});const a=t.split(`
`);t=a.pop()||"";for(const r of this.processLines(a))try{const i=JSON.parse(r);if(i.error){yield{type:"error",content:i.error,metadata:i};continue}if(i.done){this.extractUsage(i);const l={type:"done",content:""};this.usage&&(l.metadata={usage:this.usage}),yield l;continue}i.message?.content?yield{type:"token",content:i.message.content,message:{role:i.message.role||"assistant",content:i.message.content}}:i.response&&(yield{type:"token",content:i.response,message:{role:"assistant",content:i.response}})}catch{continue}}if(t.trim())try{const s=JSON.parse(t);s.done&&this.extractUsage(s),s.message?.content&&(yield{type:"token",content:s.message.content,message:{role:s.message.role||"assistant",content:s.message.content}})}catch{}const n={type:"done",content:""};this.usage&&(n.metadata={usage:this.usage}),yield n}finally{e.releaseLock()}}extractUsage(e){if(e.prompt_eval_count!==void 0||e.eval_count!==void 0){const t=e.prompt_eval_count||0,n=e.eval_count||0;this.usage={promptTokens:t,completionTokens:n,totalTokens:t+n,estimated:!1}}}}class oe{createParser(e,t){return e.includes("text/event-stream")||t.includes("openai")?new Ae:new Te}async getAvailableModels(e){if(!e.chatApiEndpoint)return[];try{const t=e.chatApiEndpoint;let n=t;if(t.includes("/v1/chat/completions"))n=t.replace("/v1/chat/completions","");else if(t.includes("/api/v1/chat/completions"))n=t.replace("/api/v1/chat/completions","");else if(t.includes("/api/chat/completion"))n=t.replace("/api/chat/completion","");else try{const l=new URL(t);n=`${l.protocol}//${l.host}`}catch{return[]}const s=`${n}/v1/models`,o={"Content-Type":"application/json"};e.apiKey&&(o.Authorization=`Bearer ${e.apiKey}`);const a=await fetch(s,{method:"GET",headers:o});return a.ok?((await a.json()).data||[]).map(l=>({id:l.id,name:l.name||l.id})):[]}catch{return[]}}async*stream(e){const t={model:e.model,stream:!0,messages:e.messages,...e.chatConfig.parameters};e.tools&&e.tools.length>0&&(t.tools=e.tools,t.tool_choice="auto");const n=await fetch(e.chatConfig.chatApiEndpoint,{method:"POST",headers:{Authorization:`Bearer ${e.chatConfig.apiKey}`,"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(t),signal:e.signal});if(!n.ok){const i=await n.text().catch(()=>"Unknown error");yield{type:"error",content:`HTTP ${n.status}: ${i}`,metadata:{status:n.status,statusText:n.statusText}};return}const s=n.headers.get("content-type")||"",o=n.headers.get("content-length");if(!n.body){yield{type:"error",content:`Response body is null or empty (Content-Length: ${o||"unknown"}). This may indicate: 1) The endpoint doesn't support streaming, 2) Authentication is required/invalid, 3) The endpoint URL is incorrect. For Open WebUI, ensure you're using the correct endpoint and API key.`,metadata:{status:n.status,contentType:s,contentLength:o,endpoint:e.chatConfig.chatApiEndpoint,hasApiKey:!!e.chatConfig.apiKey}};return}const a=n.body.getReader();if(!a){yield{type:"error",content:"Response body is not readable"};return}const r=this.createParser(s,e.chatConfig.chatApiEndpoint);try{for await(const i of r.parse(a))yield i}catch(i){yield{type:"error",content:i instanceof Error?i.message:"Failed to parse response stream",metadata:{error:i,contentType:s,endpoint:e.chatConfig.chatApiEndpoint}}}}}class we extends oe{constructor(){super(...arguments),this.name="openai"}canHandle(e){return e.chatApiEndpoint.includes("openai")||e.chatApiEndpoint.includes("v1/chat/completions")}}class ve extends oe{constructor(){super(...arguments),this.name="ollama"}canHandle(e){return e.name.toLowerCase()==="ollama"||e.chatApiEndpoint.includes("ollama")||e.chatApiEndpoint.includes("localhost:11434")}}class _e{constructor(){this.providers=[],this.registerDefaultProviders()}registerDefaultProviders(){this.providers.push(new we),this.providers.push(new ve)}registerProvider(e){this.providers.push(e)}getProvider(e){const t=this.providers.find(n=>n.canHandle(e));return t||this.providers[0]}getAllProviders(){return[...this.providers]}}class Ee{getAgentContributions(){return R.getContributions(Y)}filterAndSortAgents(e,t){return e.filter(n=>n.canHandle?n.canHandle(t):!0).sort((n,s)=>(s.priority||0)-(n.priority||0))}getMatchingAgents(e,t){const n=this.getAgentContributions();if(n.length===0)throw new Error("No agents are registered. The App Support agent should be available from the AI system extension.");let s=n.filter(o=>t&&!t.includes(o.role)?!1:o.canHandle?o.canHandle(e):!0);if(t&&t.length>0){if(s=s.sort((o,a)=>(a.priority||0)-(o.priority||0)),s.length===0){const o=t.join(", ");throw new Error(`No agents found for requested roles: ${o}. Available agents: ${n.map(a=>a.role).join(", ")}`)}}else if(s=this.filterAndSortAgents(s,e),s.length===0)throw new Error(`No agents can handle the current context. Available agents: ${n.map(o=>o.role).join(", ")}`);return s}}class se{sanitizeFunctionName(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_").replace(/^[^a-zA-Z]/,"cmd_$&").replace(/_+/g,"_").replace(/^_|_$/g,"")}commandToTool(e,t){const n={},s=[];return e.parameters?.forEach(r=>{const i=this.sanitizeFunctionName(r.name);n[i]={type:r.type||"string",description:r.description,...r.allowedValues&&{enum:r.allowedValues}},r.required===!0&&s.push(i)}),{type:"function",function:{name:this.sanitizeFunctionName(e.id),description:e.description||e.name,parameters:{type:"object",properties:n,required:s}}}}getAvailableTools(e,t){const n=S.listCommands();let s=Object.values(n);return t&&(s=s.filter(o=>t(o,e))),s.map(o=>this.commandToTool(o,e))}}const A=L("ToolDetector");class Se{constructor(){this.classifier=null,this.loading=!1,this.loadPromise=null}async ensureLoaded(){if(!this.classifier)return this.loading&&this.loadPromise?this.loadPromise:(this.loading=!0,this.loadPromise=(async()=>{try{A.info("Loading ML model for tool detection..."),this.classifier=await Ce.getPipeline(W.ZERO_SHOT_CLASSIFICATION,H.ZERO_SHOT_CLASSIFICATION,{quantized:!0}),A.info("ML model loaded successfully - will use for tool detection")}catch(e){const t=e instanceof Error?e.message:String(e);A.warn(`Failed to load ML model, will use keyword-based detection fallback: ${t}`),this.classifier=null}finally{this.loading=!1}})(),this.loadPromise)}async needsTools(e){if(!e||e.trim().length===0)return!1;const t=e.toLowerCase().trim();if(["hello","hi","hey","thanks","thank you","bye","goodbye"].some(o=>t===o||t.startsWith(o+" ")))return!1;try{if(await this.ensureLoaded(),this.classifier){A.info(`Using ML model to classify prompt: "${t.substring(0,50)}${t.length>50?"...":""}"`);const o=await this.classifier(t,["requires executing commands or actions","is a simple greeting or question"]),a=o.labels[0]==="requires executing commands or actions"&&o.scores[0]>.6;return A.info(`ML classification result: ${o.labels[0]} (confidence: ${(o.scores[0]*100).toFixed(1)}%) - needsTools: ${a}`),a}}catch(o){const a=o instanceof Error?o.message:String(o);A.warn(`ML classification failed, using keyword fallback: ${a}`)}A.info("Using keyword-based detection (ML model not available)");const s=this.keywordBasedDetection(t);return A.info(`Keyword detection result: needsTools=${s}`),s}keywordBasedDetection(e){const t=["create","open","delete","read","write","edit","save","rename","move","copy","list","show","display","run","execute","build","add","remove","update","modify","change","set","get","find","search","filter","sort","install","uninstall","load","import","export","generate","make","do","perform","call","invoke"],n=["file","folder","directory","workspace","editor","map","layer","command","tool","extension","script","code","project"],s=t.some(a=>e.includes(a)),o=n.some(a=>e.includes(a));return s&&(o||e.length>20)}dispose(){this.classifier=null,this.loading=!1,this.loadPromise=null}}const ke=new Se;class Ie{constructor(){this.toolRegistry=new se,this.enhancers=[]}addEnhancer(e){this.enhancers.push(e)}async getSysPrompt(e,t){let n=e.sysPrompt;if(typeof n=="function"&&(n=n()),!n||typeof n!="string")throw new Error(`Agent "${e.role}" (${e.label}) is missing a system prompt. All agents must provide a sysPrompt.`);const s=[...e.promptEnhancers||[],...this.enhancers,...this.getContributedEnhancers()].sort((a,r)=>(r.priority||0)-(a.priority||0));let o=n;for(const a of s)try{o=await a.enhance(o,t),(!o||typeof o!="string")&&(o=n)}catch(r){console.warn("[PromptBuilder] Enhancer failed:",r)}return o}rewriteChatHistoryForAgent(e,t){return e.map(n=>n.role==="user"?{role:n.role,content:n.content}:n.role===t?{role:"assistant",content:n.content}:{role:"user",content:`***Agent '${n.role}' replied:***
${n.content}`})}getContributedEnhancers(){return R.getContributions(ee).map(t=>({...t.enhancer,priority:t.priority??t.enhancer.priority}))}async build(e,t,n,s){s?.beforeSend&&await s.beforeSend(t,n);const o=this.sanitizeMessagesForAPI(t),a=this.rewriteChatHistoryForAgent(o,e.role);let r=e.tools;typeof r=="function"&&(r=await r());let i;if(r?.enabled)if(r.smartToolDetection){const g=t[t.length-1]?.content||"";await ke.needsTools(g)&&(i=this.toolRegistry.getAvailableTools(n,r.commandFilter))}else i=this.toolRegistry.getAvailableTools(n,r.commandFilter);const l=await this.getSysPrompt(e,n);a.unshift({role:"system",content:l});const h=a.length-1;return{messages:a,userPromptIndex:h,tools:i}}sanitizeMessageForAPI(e){const t={role:e.role,content:e.content};return"tool_call_id"in e&&e.tool_call_id&&(t.tool_call_id=e.tool_call_id),"tool_calls"in e&&e.tool_calls&&(t.tool_calls=e.tool_calls),t}sanitizeMessagesForAPI(e){return e.map(t=>this.sanitizeMessageForAPI(t))}}class Pe{constructor(){this.processors=[]}addProcessor(e){this.processors.push(e)}getSortedProcessors(){return[...this.processors].sort((e,t)=>(t.priority||0)-(e.priority||0))}async process(e,t,n){let s={...e};const o=[...t.messageProcessors||[],...this.processors].sort((r,i)=>(i.priority||0)-(r.priority||0));for(const r of o)s=await r.process(s,n);const a=s.actions?.some(r=>r.requiresAttention)||s.attentionRequests?.some(r=>r.requiresAction)||!1;return{...s,requiresAttention:a}}checkRequiresAttention(e){return e.actions?.some(t=>t.requiresAttention)||e.attentionRequests?.some(t=>t.requiresAction)||!1}}class xe{constructor(){this.accumulatedToolCalls=new Map,this.toolCallIndexMap=new Map}processChunk(e){if(e.type==="token"&&e.toolCalls&&e.toolCalls.length>0)for(const t of e.toolCalls){const n=t._index,s=t.id;let o,a;if(n!==void 0&&this.toolCallIndexMap.has(n)?(a=this.toolCallIndexMap.get(n),o=this.accumulatedToolCalls.get(a)):s&&this.accumulatedToolCalls.has(s)?(a=s,o=this.accumulatedToolCalls.get(a)):(a=s||`call_${n!==void 0?n:Date.now()}_${Math.random()}`,o=void 0),o){const r=o.function.arguments||"",i=t.function.arguments||"",l=r+i;this.accumulatedToolCalls.set(a,{id:a,type:t.type||o.type,function:{name:t.function.name||o.function.name,arguments:l}}),n!==void 0&&!this.toolCallIndexMap.has(n)&&this.toolCallIndexMap.set(n,a)}else this.accumulatedToolCalls.set(a,{...t,id:a}),n!==void 0&&this.toolCallIndexMap.set(n,a)}}getFinalToolCalls(){return Array.from(this.accumulatedToolCalls.values()).filter(e=>e.function.name&&e.function.name.trim().length>0).map(e=>{let t=e.function.arguments||"";return(!t||t.trim()==="")&&(t="{}"),{...e,function:{...e.function,arguments:t}}})}reset(){this.accumulatedToolCalls.clear(),this.toolCallIndexMap.clear()}}class ae{sanitizeFunctionName(e){return e.replace(/[^a-zA-Z0-9_-]/g,"_").replace(/^[^a-zA-Z]/,"cmd_$&").replace(/_+/g,"_").replace(/^_|_$/g,"")}findCommand(e,t){const n=e.function.name,s=S.getCommand(n);if(s)return s;const o=S.listCommands();for(const[a,r]of Object.entries(o))if(this.sanitizeFunctionName(a)===n)return r;return null}parseArguments(e){if(!e||e.trim()===""||e==="{}")return{};try{const t=JSON.parse(e);return t&&typeof t=="object"?t:{}}catch(t){const n=t instanceof Error?t.message:String(t);return console.error(`[ToolExecutor] Failed to parse arguments: ${e} - ${n}`),{}}}sanitizeArguments(e,t){if(!t||!t.parameters||!e||typeof e!="object")return e||{};const n={};return t.parameters.forEach(s=>{const o=this.sanitizeFunctionName(s.name);o in e&&(n[s.name]=e[o])}),n}async executeToolCall(e,t){try{const n=this.findCommand(e,t),s=n?.id||e.function.name,o=e.function.arguments||"{}",a=this.parseArguments(o),r=this.sanitizeArguments(a,n),i=S.createExecutionContext(r),l={...t,...i,params:r};let h=await S.execute(s,l);const g={success:!0,message:`Command "${n?.name||s}" executed successfully`,command:s};if(r&&typeof r=="object"&&Object.keys(r).length>0&&(g.parameters=r),h){let C=h;if(C instanceof Promise&&(C=await C),g.result=C,n?.output&&n.output.length>0){const d=n.output.map(m=>`${m.name}: ${m.description||m.type||"value"}`).join(", ");g.output=d}}return{id:e.id,result:g}}catch(n){const s=n instanceof Error?n.message:String(n);let o=null;try{o=this.findCommand(e,t)}catch{o=null}const a=o?.name||e.function.name;let r=s;return s.includes("No handler found")||s.includes("No handlers registered")?r=`Command "${a}" cannot be executed. ${s}. This usually means the command is not available in the current context (e.g., a map editor may not be open or active).`:(s.includes("not available")||s.includes("GsMapEditor"))&&(r=`Command "${a}" cannot be executed: ${s}. Please ensure the required editor or component is open and active.`),{id:e.id,result:null,error:r}}}async executeToolCalls(e,t){const n=[];for(const s of e){const o=await this.executeToolCall(s,t);n.push(o)}return n}createToolCallAccumulator(){return new xe}createToolCallSignature(e){const t=e.function.arguments||"{}";let n={};try{const o=JSON.parse(t);n=o&&typeof o=="object"?o:{}}catch{n={}}const s=n&&typeof n=="object"?Object.keys(n).sort().reduce((o,a)=>(o[a]=n[a],o),{}):{};return`${e.function.name}:${JSON.stringify(s)}`}}const Le=Object.freeze(Object.defineProperty({__proto__:null,ToolExecutor:ae},Symbol.toStringTag,{value:"Module"}));class Oe{async execute(e,t,n,s){const o=t.chatConfig;if(!o)throw new Error("Chat config is required");const a=e.map(async r=>{try{await s(r,t.chatContext.history,n.sharedState,o,t,n)}catch(i){const l=i instanceof Error?i:new Error(String(i));n.errors.set(r.role,l),t.onAgentError?.(r.role,l)}});await Promise.all(a)}}class be{async execute(e,t,n,s){const o=t.chatConfig;if(!o)throw new Error("Chat config is required");let a=[...t.chatContext.history],r={...n.sharedState};for(const i of e)try{const l=this.createAgentContextWithPreviousAgents(r,t,n),h=await s(i,a,r,o,t,n);if(!h)break;const u=this.updateWorkflowState(h,a,r,l,n);a=u.currentMessages,r=u.accumulatedState}catch(l){const h=l instanceof Error?l:new Error(String(l));n.errors.set(i.role,h),t.onAgentError?.(i.role,h);break}}createAgentContextWithPreviousAgents(e,t,n){return{...e,...t.callContext.getProxy(),previousAgents:Array.from(n.messages.entries()).map(([s,o])=>({role:s,content:o.content}))}}updateWorkflowState(e,t,n,s,o){return t.push(e),n={...n,...s,message:e},o.sharedState=n,{currentMessages:t,accumulatedState:n}}}class Re{async execute(e,t,n,s){const o=t.chatConfig;if(!o)throw new Error("Chat config is required");let a=[...t.chatContext.history],r={...n.sharedState};for(const i of e)try{const l=this.createAgentContextWithPreviousAgents(r,t,n);if(i.canHandle&&!i.canHandle(l))continue;const h=await s(i,a,r,o,t,n);if(!h)break;const u=this.updateWorkflowState(h,a,r,l,n);a=u.currentMessages,r=u.accumulatedState}catch(l){const h=l instanceof Error?l:new Error(String(l));n.errors.set(i.role,h),t.onAgentError?.(i.role,h)}}createAgentContextWithPreviousAgents(e,t,n){return{...e,...t.callContext.getProxy(),previousAgents:Array.from(n.messages.entries()).map(([s,o])=>({role:s,content:o.content}))}}updateWorkflowState(e,t,n,s,o){return t.push(e),n={...n,...s,message:e},o.sharedState=n,{currentMessages:t,accumulatedState:n}}}class Ne{constructor(){this.strategies=new Map([["parallel",new Oe],["sequential",new be],["conditional",new Re]])}registerStrategy(e,t){this.strategies.set(e,t)}async execute(e,t,n){const s=`workflow-${Date.now()}-${Math.random()}`,o=t.execution||"parallel",a=t.sharedState||{},r={messages:new Map,sharedState:{...a},errors:new Map};y(B,{workflowId:s,options:t});try{const i=this.strategies.get(o);if(!i)throw new Error(`Unknown workflow execution strategy: ${o}`);return await i.execute(e,t,r,n),y(V,{workflowId:s,results:r}),r}catch(i){const l=i instanceof Error?i:new Error(String(i));throw y(Z,{workflowId:s,error:l}),l}}}const P=class{static estimateTokens(e){if(!e||e.trim().length===0)return 0;const t=e.trim(),n=t.length,s=t.split(/\s+/).filter(a=>a.length>0).length,o=Math.ceil(n/this.AVERAGE_CHARS_PER_TOKEN+s*.3);return Math.max(1,o)}static estimateMessageTokens(e){let t=this.MESSAGE_OVERHEAD;if(e.content&&(t+=this.estimateTokens(e.content)),e.role&&(t+=this.estimateTokens(e.role)),e.tool_calls)for(const n of e.tool_calls)t+=this.estimateTokens(n.function.name||""),t+=this.estimateTokens(n.function.arguments||"{}"),t+=10;return e.tool_call_id&&(t+=this.estimateTokens(e.tool_call_id)),t}static estimatePromptTokens(e,t){let n=0;for(const s of e)n+=this.estimateMessageTokens(s);if(t&&t.length>0){for(const s of t)if(n+=this.TOOL_DEFINITION_OVERHEAD,n+=this.estimateTokens(s.function.name||""),n+=this.estimateTokens(s.function.description||""),s.function.parameters){const o=JSON.stringify(s.function.parameters);n+=this.estimateTokens(o)}}return n}static estimateCompletionTokens(e,t){let n=this.estimateTokens(e);if(t&&t.length>0)for(const s of t)n+=10,n+=this.estimateTokens(s.function?.name||""),n+=this.estimateTokens(s.function?.arguments||"{}");return n}};P.AVERAGE_CHARS_PER_TOKEN=4;P.TOOL_DEFINITION_OVERHEAD=50;P.MESSAGE_OVERHEAD=4;let U=P;const z="ai_token_usage";class Me{constructor(){this.data=null,this.loadPromise=null}async loadData(){return this.data?this.data:this.loadPromise?this.loadPromise:(this.loadPromise=(async()=>{const e=await F.getObject(z);return e?this.data=e:(this.data={providers:{},total:{promptTokens:0,completionTokens:0,totalTokens:0,requestCount:0},lastUpdated:Date.now()},await this.saveData()),this.loadPromise=null,this.data})(),this.loadPromise)}async saveData(){this.data&&(this.data.lastUpdated=Date.now(),await F.persistObject(z,this.data))}async recordUsage(e,t){if(await this.loadData(),!this.data)return;this.data.providers[e]||(this.data.providers[e]={promptTokens:0,completionTokens:0,totalTokens:0,requestCount:0});const n=this.data.providers[e];n.promptTokens+=t.promptTokens,n.completionTokens+=t.completionTokens,n.totalTokens+=t.totalTokens,n.requestCount+=1,this.data.total.promptTokens+=t.promptTokens,this.data.total.completionTokens+=t.completionTokens,this.data.total.totalTokens+=t.totalTokens,this.data.total.requestCount+=1,await this.saveData()}async getProviderUsage(e){return await this.loadData(),this.data?.providers[e]||null}async getAllProviderUsage(){return await this.loadData(),this.data?.providers||{}}async getTotalUsage(){return await this.loadData(),this.data?.total||{promptTokens:0,completionTokens:0,totalTokens:0,requestCount:0}}async reset(){this.data={providers:{},total:{promptTokens:0,completionTokens:0,totalTokens:0,requestCount:0},lastUpdated:Date.now()},await this.saveData()}async resetProvider(e){if(await this.loadData(),!this.data)return;const t=this.data.providers[e];t&&(this.data.total.promptTokens-=t.promptTokens,this.data.total.completionTokens-=t.completionTokens,this.data.total.totalTokens-=t.totalTokens,this.data.total.requestCount-=t.requestCount,delete this.data.providers[e],await this.saveData())}}const qe=new Me;class $e{constructor(){this.activeRequests=new Map,this.providerFactory=new _e,this.agentRegistry=new Ee,this.promptBuilder=new Ie,this.messageProcessor=new Pe,this.toolExecutor=new ae,this.workflowEngine=new Ne,this.toolRegistry=new se,de(he,()=>{this.aiConfig=void 0,this.configCheckPromise=void 0,this.checkAIConfig().then()}),this.checkAIConfig().then()}getAgentContributions(){return this.agentRegistry.getAgentContributions()}async getProviders(){return await this.checkAIConfig(),this.aiConfig?.providers||[]}async getDefaultProvider(){await this.checkAIConfig();const e=await this.getProviders();if(this.aiConfig?.defaultProvider){const t=e.find(n=>n.name===this.aiConfig?.defaultProvider);if(t)return t}return e[0]}async setDefaultProvider(e){return await this.checkAIConfig(),this.aiConfig&&(this.aiConfig.defaultProvider=e,await _.set(T,this.aiConfig)),this.getDefaultProvider()}createMessage(e){return{role:"user",content:e}}registerStreamingFetcher(e){this.providerFactory.registerProvider(e)}getContributedProviders(){return R.getContributions(Q).map(t=>t.provider)}mergeProviders(e,t){const n=new Set(e.map(o=>o.name)),s=t.filter(o=>!n.has(o.name));return s.length>0?[...e,...s]:e}async createInitialConfig(){const e=this.getContributedProviders(),t={...te,providers:e};return await _.set(T,t),await _.get(T)}async updateConfigWithMissingProviders(e){const t=this.getContributedProviders(),n=this.mergeProviders(e.providers,t);if(n.length!==e.providers.length){const s={...e,providers:n};return await _.set(T,s),s}return e}async checkAIConfig(){if(!this.aiConfig)return this.configCheckPromise?this.configCheckPromise:(this.configCheckPromise=this.performConfigCheck(),this.configCheckPromise)}async performConfigCheck(){try{this.aiConfig=await _.get(T),this.aiConfig?this.aiConfig=await this.updateConfigWithMissingProviders(this.aiConfig):this.aiConfig=await this.createInitialConfig(),y(J,this.aiConfig)}finally{this.configCheckPromise=void 0}}createAgentContext(e,t,n={}){return{...e,...t.getProxy(),...n}}createFinalMessage(e,t){return{role:e.role,content:t.content,actions:t.actions,requiresAttention:t.requiresAttention,attentionRequests:t.attentionRequests,canContinue:t.canContinue}}async handleUserAttention(e,t,n,s){if(!t.requiresAttention||!n.userAttentionHandler)return!0;const o=[];if(t.attentionRequests&&o.push(...t.attentionRequests),t.actions)for(const i of t.actions)i.requiresAttention&&i.attentionRequest&&o.push(i.attentionRequest);if(o.length===0)return!0;if(s.pendingAttention||(s.pendingAttention=new Map),s.pendingAttention.set(e,o),n.onAttentionRequest)for(const i of o)n.onAttentionRequest(e,i);if(n.pauseOnAttention)return s.paused=!0,s.continuationToken=`${e}-${Date.now()}-${Math.random()}`,!1;const a=n.userAttentionHandler,r=this.createAgentContext(n.sharedState||{},n.callContext,{message:t});for(const i of o)if(a.onAttentionRequest){const l=await a.onAttentionRequest(i,r);if(i.requiresAction&&(l===!1||l===null))return!1;l&&typeof l=="string"&&(r[`attention_${i.type}_result`]=l)}else switch(i.type){case"confirmation":if(a.onConfirmation&&!await a.onConfirmation(i.message,r)&&i.requiresAction)return!1;break;case"input":if(a.onInput){const l=await a.onInput(i.message,void 0,r);if(!l&&i.requiresAction)return!1;l&&(r.attention_input_result=l)}break}return!0}async*streamCompletion(e){const t=`${Date.now()}-${Math.random()}`,n=new AbortController;this.activeRequests.set(t,n),e.signal&&e.signal.addEventListener("abort",()=>{n.abort()});const s=e.signal||n.signal;try{e.onStatus?.("starting"),y(j,{requestId:t,options:e});const o=e.chatConfig||await this.getDefaultProvider(),a=this.sanitizeMessagesForAPI(e.chatContext.history),r=this.providerFactory.getProvider(o),i=this.toolExecutor.createToolCallAccumulator();let l="",h={role:"assistant",content:""},u;for await(const d of r.stream({model:o.model,messages:a,chatConfig:o,tools:e.tools,signal:s})){if(d.type==="error"){e.onStatus?.("error"),y(I,{requestId:t,chunk:d}),yield d;break}if(d.type==="token")i.processChunk(d),(!d.toolCalls||d.toolCalls.length===0)&&(l+=d.content,h.content=l),d.message?.role&&(h.role=d.message.role),d.content&&e.onToken?.(d.content),e.onStatus?.("streaming"),e.onProgress?.({received:l.length}),y(G,{requestId:t,chunk:d}),yield d;else if(d.type==="done"){d.metadata?.usage&&(u=d.metadata.usage),e.onStatus?.("complete"),y(K,{requestId:t}),yield d;break}else yield d}const g=i.getFinalToolCalls(),C={role:h.role||"assistant",content:l||"",...g.length>0&&{toolCalls:g}};if(!u){const d=U.estimatePromptTokens(a,e.tools),m=U.estimateCompletionTokens(l,g);u={promptTokens:d,completionTokens:m,totalTokens:d+m,estimated:!0}}return qe.recordUsage(o.name,u).catch(d=>{fe.error(`Failed to record token usage: ${d instanceof Error?d.message:String(d)}`)}),{message:C,tokenUsage:u}}catch(o){if(o instanceof Error&&o.name==="AbortError")throw e.onStatus?.("error"),y(I,{requestId:t,error:"Request cancelled"}),o;e.onStatus?.("error");const a=o instanceof Error?o.message:String(o);throw y(I,{requestId:t,error:a}),yield{type:"error",content:a,metadata:{error:o}},o}finally{this.activeRequests.delete(t)}}async handleStreamingPromptDirect(e){const t=this.streamCompletion(e);let n;for(;;){if(n=await t.next(),n.done)return n.value.message;const s=n.value;if(s.type==="error")throw new Error(s.content);if(s.type==="done"){const o=await t.next();if(o.done&&o.value)return o.value.message;if(!o.done)continue;throw new Error("Stream completed without return value")}}}sanitizeMessageForAPI(e){const t={role:e.role,content:e.content};return"tool_call_id"in e&&e.tool_call_id&&(t.tool_call_id=e.tool_call_id),"tool_calls"in e&&e.tool_calls&&(t.tool_calls=e.tool_calls),t}sanitizeMessagesForAPI(e){return e.map(t=>this.sanitizeMessageForAPI(t))}async handleStreamingPrompt(e){const t=e.callContext||ge.createChild({}),n=this.createAgentContext({},t,{userPrompt:e.chatContext.history[e.chatContext.history.length-1]?.content||""}),s=this.agentRegistry.getMatchingAgents(n),o=s.length>0?s.map(i=>i.role):["assistant"],a=await this.executeAgentWorkflow({chatContext:e.chatContext,chatConfig:e.chatConfig,callContext:t,execution:"parallel",stream:e.stream,signal:e.signal,onToken:(i,l)=>{e.onToken?.(l)},onStatus:(i,l)=>{e.onStatus?.(l)},roles:o}),r=Array.from(a.messages.values());return r.length===1?r[0]:r}async continueWorkflow(e,t,n){const s={sharedState:{...n.sharedState,...Object.fromEntries(t)}},o={...n,sharedState:s.sharedState,pauseOnAttention:!1};return this.executeAgentWorkflow(o)}cancelRequest(e){const t=this.activeRequests.get(e);return t?(t.abort(),this.activeRequests.delete(e),!0):!1}async executeAgentWorkflow(e){const t=this.createAgentContext(e.sharedState||{},e.callContext),n=this.agentRegistry.getMatchingAgents(t,e.roles);return this.workflowEngine.execute(n,e,async(s,o,a,r,i,l)=>this.executeAgent(s,o,a,r,i,l))}async executeAgent(e,t,n,s,o,a){o.onAgentStart?.(e.role);const r=this.createAgentContext(n,o.callContext,{userPrompt:t[t.length-1]?.content||""}),{messages:i,tools:l}=await this.promptBuilder.build(e,t,r,e.hooks),h=i.map(p=>{const v={role:p.role,content:p.content};return p.tool_call_id&&(v.tool_call_id=p.tool_call_id),p.tool_calls&&(v.tool_calls=p.tool_calls),v});let u=await this.handleStreamingPromptDirect({chatContext:{history:h},chatConfig:s,callContext:o.callContext,stream:o.stream??!0,signal:o.signal,tools:l}),g=0;const C=[...i];for(;u.toolCalls&&u.toolCalls.length>0;){if(g++,g>b){console.warn(`[AIService] Maximum tool call iterations (${b}) reached`);break}let p=[];if(o.requireToolApproval&&o.onToolApprovalRequest){const f=u.toolCalls.map(k=>{const le=k.function.arguments||"{}";let x={};try{x=JSON.parse(le)}catch{x={}}return`${k.function.name}(${Object.entries(x).map(([$,ce])=>`${$}=${ce}`).join(", ")})`}).join(", "),ie={toolCalls:u.toolCalls,message:`The AI wants to execute: ${f}`};await o.onToolApprovalRequest(e.role,ie)?p=await this.toolExecutor.executeToolCalls(u.toolCalls,r):p=u.toolCalls.map(k=>({id:k.id,result:{success:!1,message:"Tool execution cancelled by user",cancelled:!0}}))}else p=await this.toolExecutor.executeToolCalls(u.toolCalls,r);const v=p.map(f=>({role:"tool",content:f.error?JSON.stringify({error:f.error}):JSON.stringify(f.result),tool_call_id:f.id})),N={role:"assistant",content:u.content||""};u.toolCalls&&u.toolCalls.length>0&&(N.tool_calls=u.toolCalls.filter(f=>f.function.name&&f.function.name.trim().length>0).map(f=>({id:f.id,type:f.type,function:{name:f.function.name,arguments:f.function.arguments||"{}"}}))),C.push(N,...v);const re=C;u=await this.handleStreamingPromptDirect({chatContext:{history:re.map(f=>({role:f.role,content:f.content,...f.tool_call_id&&{tool_call_id:f.tool_call_id},...f.tool_calls&&{tool_calls:f.tool_calls}}))},chatConfig:s,callContext:o.callContext,stream:o.stream??!0,signal:o.signal,tools:l});const M=u.content&&u.content.trim().length>0,q=u.toolCalls&&u.toolCalls.length>0;if(M&&!q)break;if(M&&q){console.warn("[AIService] Model provided content but also called tools - treating as completion");break}}const d=await this.messageProcessor.process(u,e,this.createAgentContext(n,o.callContext,{message:u}));e.hooks?.afterReceive&&await e.hooks.afterReceive(d,this.createAgentContext(n,o.callContext));const m=this.createFinalMessage(e,d);return!await this.handleUserAttention(e.role,m,o,a)&&o.pauseOnAttention?null:(a.messages.set(e.role,m),o.onAgentComplete?.(e.role,m),m)}}const We=new $e;export{te as A,oe as B,Y as C,T as K,ye as M,ve as O,Oe as P,be as S,V as T,Ne as W,Ee as a,Q as b,ee as c,Re as d,b as e,Pe as f,we as g,Ie as h,_e as i,Z as j,B as k,J as l,G as m,K as n,I as o,j as p,xe as q,ae as r,se as s,We as t,qe as u,ze as v,Le as w};
